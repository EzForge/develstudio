<? if (SE_INC_READY === true) return; define('SE_INC_READY', true); function _empty(){} function replaceSl($s){return str_replace("\\","/",$s);} function replaceSr($s){return str_replace("/","\\",$s);} function pre($obj){ $s = print_r($obj,true); __message ($s); } function pre2($obj){ ob_start(); var_dump($obj); $s = ob_get_contents(); ob_end_clean(); msg ($s); } function include_lib($class,$name){ require ENGINE_DIR . $class . '/' . $name . '.php'; } global $progDir, $moduleDir, $engineDir; $progDir = str_replace('\\\\','\\',$progDir); $prs2 = basename(param_str(2)); $prs2_ext = strtolower(substr($prs2, strrpos($prs2,'.')+1, strlen($prs2)-strrpos($prs2,'.')-1)); if ($prs2_ext=='dvsexe' || $prs2_ext=='mspprexe'){ define(DOC_ROOT2, str_replace('//','/',replaceSl($progDir))); $progDir = replaceSr(dirname( param_str(2) )).'\\'; } define('DOC_ROOT',str_replace('//','/',replaceSl($progDir))); define('MODULE_DIR',replaceSl($moduleDir)); define('ENGINE_DIR',replaceSl($engineDir)); define('DRIVE_CHAR', $progDir[0]); define('progDir',$progDir); set_include_path(DOC_ROOT); $_SERVER['DOCUMENT_ROOT'] = DOC_ROOT; $_SERVER['MODULE_DIR'] = MODULE_DIR; $_SERVER['ENGINE_DIR'] = ENGINE_DIR;?><? class myVars { static function set($var, $name){ $GLOBALS[$name] = $var; } static function set2(&$var, $name){ $GLOBALS[$name] =& $var; } static function get($name){ if (isset($GLOBALS[$name])) return $GLOBALS[$name]; else return false; } } class TConstantList{ public $defines; function __set($nm,$val){ if (!defined($nm)){ $this->defines[$nm] = $val; define($nm,$val, false); } } function __get($nm){ return $this->defines[$nm]; } function setConstList($names,$beg = 1){ for($i=0;$i<count($names);$i++){ if (! defined($names[$i]) ){ define($names[$i],$i+$beg, false); $this->defines[$names[$i]] = $i+$beg; } } } } $GLOBALS['_c'] = new TConstantList; ?><? $GLOBALS['__show_errors'] = true; function userErrorHandler($errno = false, $errmsg = '', $filename='', $linenum=0, $vars=false) { if ($errno == E_NOTICE) return; if ($errno == 2048) return; if (!$errno){ $prs = v('__'.__FUNCTION__); $errno = $prs[0]; $errmsg = $prs[1]; $filename = $prs[2]; $linenum = $prs[3]; $GLOBALS['__eventInfo'] = v('__eventInfo'); } if (defined('ERROR_NO_WARNING')){ if ($errno == E_WARNING || $errno == E_CORE_WARNING || $errno == E_USER_WARNING) return; } if (defined('ERROR_NO_ERROR')){ if ($errno == E_ERROR || $errno == E_CORE_ERROR || $errno == E_USER_ERROR) return; } if (defined('IS_THREAD') && $GLOBALS['__show_errors']){ v('__'.__FUNCTION__, array($errno, $errmsg, $filename, $linenum)); v('__eventInfo', $GLOBALS['__eventInfo']); c('form1')->text = serialize($GLOBALS['__eventInfo']); Thread::func('userErrorHandler'); return; } $GLOBALS['__error_last'] = array( 'msg'=>$errmsg, 'file'=>$filename, 'line'=>$linenum, 'type'=>$errno, ); if (!$GLOBALS['__show_errors'] || v('is_showerror')) return; v('is_showerror', true); global $__eventInfo; $errortype = array ( E_ERROR => "Error", E_WARNING => "Warning", E_PARSE => "Parsing Error", E_NOTICE => "Notice", E_CORE_ERROR => "Core Error", E_CORE_WARNING => "Core Warning", E_COMPILE_ERROR => "Compile Error", E_COMPILE_WARNING => "Compile Warning", E_USER_ERROR => "User Error", E_USER_WARNING => "User Warning", E_USER_NOTICE => "User Notice", E_STRICT => "Runtime Notice" ); $type = $errortype[$errno]; if (defined('DEBUG_OWNER_WINDOW')){ $result['type'] = 'error'; $result['script'] = $filename; $result['event'] = $__eventInfo['name']; $result['name'] = $__eventInfo['obj_name']; $result['msg'] = $errmsg; $result['errno']= $errno; $result['errtype'] = $type; $result['line'] = $linenum; $result['vars'] = array_keys($vars); application_minimize(); Receiver::send(DEBUG_OWNER_WINDOW, $result); application_restore(); $GLOBALS['APPLICATION']->toFront(); v('is_showerror', false); return; } $arr[]= '['.$type.']'; $arr[]= t('Message').': "' . $errmsg . '"'; if (file_exists($filename)){ $arr[]= ' '; if (defined('EXE_NAME')) $filename = str_replace(replaceSr(dirname(replaceSl(EXE_NAME))),'',$filename); $arr[] = $filename; $arr[] = t('On Line').': ' . $linenum; } if ($__eventInfo){ $arr[] = ' '; $arr[] = '['.t('EVENT').']'; if ($__eventInfo['name']) $arr[] = t('Type').': '.$__eventInfo['name']; if ($__eventInfo['obj_name']) $arr[] = t('Object').': "' .$__eventInfo['obj_name'].'"'; } $arr[] = ' '; $arr[] = '.:: '.t('To abort application?').' ::.'; $str = implode(_BR_, $arr); message_beep(MB_ICONERROR); $old_error_handler = set_error_handler("userErrorHandler"); switch (messageDlg($str, mtError, MB_OKCANCEL)){ case mrCancel: v('is_showerror', false); return true; case mrOk: application_terminate(); v('is_showerror', false); return false; break; } return; } $old_error_handler = set_error_handler("userErrorHandler"); function error_message($msg){ messageBox($msg, appTitle() . ': Error', MB_ICONERROR); die(); } function error_msg($msg){ messageBox($msg, appTitle() . ': Error', MB_ICONERROR); } function __error_hook($type, $filename, $line, $msg){ error_message("'$msg' in '$filename' on line $line"); } function checkFile($filename){ $filename = str_replace('//','/',replaceSl($filename)); if (!file_exists(DOC_ROOT . $filename) && !file_exists($filename)){ error_message("'$filename' is not exists!"); die(); } } function err_no(){ $GLOBALS['__show_errors'] = false; $GLOBALS['__error_last'] = false; } function err_status($value = null){ $GLOBALS['__error_last'] = false; if ($value===null) return $GLOBALS['__show_errors']; else{ $res = $GLOBALS['__show_errors']; $GLOBALS['__show_errors'] = $value; return $res; } } function err_yes(){ $GLOBALS['__show_errors'] = true; $GLOBALS['__error_last'] = false; } function err_msg(){ return $GLOBALS['__error_last']['msg']; } function err_last(){ return $GLOBALS['__error_last']; }?><? class TConfig{ public $class_name = __CLASS__; protected $_data; public function __construct(array $data = array()){ $this->_data = array(); $this->setArray($data); } public function setArray(array $data){ foreach ($data as $key => $value) { if (is_array($value)) { $this->_data[$key] = new self($value); } else { $this->_data[$key] = $value; } } } public function get($name, $default = null){ $result = $default; if (array_key_exists($name, $this->_data)) { $result = $this->_data[$name]; } return $result; } public function __get($name){ return $this->get($name); } public function __set($name,$value){ if (is_array($value)) { $this->_data[$name] = new self($value); } else { $this->_data[$name] = $value; } } public function toArray() { $array = array(); foreach ($this->_data as $key => $value) { if ($value instanceof TConfig) { $array[$key] = $value->toArray(); } else { $array[$key] = $value; } } return $array; } public function __isset($name) { return isset($this->_data[$name]); } public function __clone() { $array = array(); foreach ($this->_data as $key => $value) { if ($value instanceof TConfig) { $array[$key] = clone $value; } else { $array[$key] = $value; } } $this->_data = $array; } public function loadFromFile($filename){} public function saveToFile($filename){} }?><? define('nil',-1); define('OS_WIN',1); define('OS_UNIX',2); define('OS_MACOS',3); define('__SYSTEM__',OS_WIN); switch(__SYSTEM__){ case OS_WIN: define('_BR_',chr(13).chr(10)); break; case OS_UNIX: define('_BR_',chr(13)); break; case OS_MACOS: defina('_BR_',chr(10)); break; default: define('_BR_',chr(13).chr(13)); } class _Object { protected $props = array(); protected $class_name = __CLASS__; function __get($nm) { $s = 'get_'.$nm; $s2 = 'getx_'.$nm; $isset = true; if (method_exists($this,$s2)){ return $this->$s2(); } elseif (method_exists($this,$s)) return $this->$s(); elseif (property_exists($this,$nm)) return $this->$nm; elseif (array_key_exists($nm,$this->props) && method_exists($this,'setx_'.$nm)){ return $this->__getPropEx($nm); } elseif (array_key_exists($nm,$this->props)) { return $this->props[$nm]; } else { return -908067676; } } function __set($nm, $val) { $s = 'set_'.$nm; $s2 = 'setx_'.$nm; if (property_exists($this,$nm)){ $this->$nm = $val; } elseif (method_exists($this,$s2)) { $this->props[$nm] = $val; } if (method_exists($this,$s)) $this->$s($val); if (method_exists($this,$s2)) $this->$s2($val); } } class TObject extends _Object { public $self; function get_className(){ return rtii_class($this->self); } function isClass($class){ if (is_array($class)){ $s_class = strtolower($this->className); foreach ($class as $el) if (strtolower($el)==$s_class) return true; return false; } else { $class = strtolower($class); return $class==strtolower($this->className); } } function __construct($init = true){ $this->self = component_create(__CLASS__,nil); } function free(){ if (link_null($this->self)) return; if (class_exists('animate')) animate::objectFree($this->self); obj_free($this->self); } function destroy(){ $this->free(); } } function rtii_set($obj,$prop,$val){__rtii_set($obj->self,$prop,$val);} function rtii_get($obj,$prop){return __rtii_get($obj->self,$prop);} function rtii_exists($obj,$prop){return __rtii_exists($obj->self,$prop);} function rtii_is_object($obj, $class){ return __rtii_is_class($obj->self, $class); } function get_owner($obj){return cntr_owner($obj->self);} function obj_create($class,$onwer,&$obj){ if (is_object($onwer) && property_exists($onwer, 'self')){ return component_create($class,$onwer->self); } else return component_create($class,nil); } class TComponent extends TObject { function getHelpKeyword(){ return control_helpkeyword($this->self, null); } function setHelpKeyword($v){ control_helpkeyword($this->self, $v); } function __addPropEx($nm, $val){ if (!is_string($val) && !is_integer($val) && !is_float($val) && !is_bool($val)){ if (is_array($val)) $val = serialize($val); else return; } $class = $this->class_name_ex ? $this->class_name_ex : $this->class_name; $result = unserialize(base64_decode($this->getHelpKeyword())); $nm = strtolower($nm); if ($val===NULL) unset($result['PARAMS'][$nm]); else $result['PARAMS'][$nm] = $val; $this->setHelpKeyword( base64_encode(serialize( array('CLASS' => $class, 'PARAMS'=> $result['PARAMS'], ))) ); } function __setClass(){ $class = $this->class_name_ex ? $this->class_name_ex : $this->class_name; $result = unserialize(base64_decode($this->getHelpKeyword())); $this->helpKeyword = base64_encode(serialize( array('CLASS' => $class, 'PARAMS'=> $result['PARAMS'], ))); } function __getPropEx($nm){ $nm = strtolower($nm); $result = unserialize(base64_decode($this->getHelpKeyword())); if (!isset($result['PARAMS'][$nm])) return NULL; if (strpos($result['PARAMS'][$nm],':{')!==false){ return unserialize($result['PARAMS'][$nm]); } else { return $result['PARAMS'][$nm]; } } static function __getPropExArray($self){ $result = unserialize(base64_decode(control_helpkeyword($self, null))); foreach ($result['PARAMS'] as $nm=>$value){ if (strpos($result['PARAMS'][$nm],':{')!==false){ $result['PARAMS'][$nm] = unserialize($result['PARAMS'][$nm]); } } return $result['PARAMS']; } function __setAllPropEx($init = true){ if ($init) $this->__setClass(); } function __setAllPropX(){ $result = unserialize(base64_decode( $this->getHelpKeyword() )); foreach ((array)$result['PARAMS'] as $prop=>$value){ $this->props[strtolower($prop)] = $value; $this->$prop = $value; } } function __initComponentInfo(){ $this->visible = $this->avisible; $this->enabled = $this->aenabled; } function __construct($onwer = nil,$init = true,$self = nil){ if ($init){ $this->self = obj_create($this->class_name,$onwer,$this); } if ($self != nil) $this->self = $self; $this->__setAllPropEx($init); } function set_prop($prop,$val){ rtii_set($this,$prop,$val); } function get_prop($prop){ $result = rtii_get($this,$prop); if ($result==='True') $result = true; elseif ($result==='False') $result = false; return $result; } function exists_prop($prop){ return rtii_exists($this,$prop); } function __set($nm,$val){ $nm = strtolower($nm); if (!method_exists($this,'set_'.$nm)) if ($this->class_name!='TWebBrowser' && $this->class_name!='TScreenEx' && $this->class_name!='TPen' && $this->class_name!='TImageList'){ if ($nm=='visible'){ return control_visible($this->self, $val); } elseif ($nm=='left'){ return control_x($this->self, $val); } elseif ($nm=='top'){ return control_y($this->self, $val); } elseif ($nm=='width'){ return control_w($this->self, $val); } elseif ($nm=='height'){ return control_h($this->self, $val); } } if (strtolower(substr($nm,0,2)) == 'on'){ $result = set_event($this->self,$nm,$val); if ( method_exists($this, 'set_'.$nm) ){ $method = 'set_'.$nm; $this->$method($val); } if ($result) return; } if (!$this->exists_prop($nm)){ $this->__addPropEx($nm,$val); parent::__set($nm,$val); } else { $s = 'set_'.$nm; if (method_exists($this,'set_'.$nm)) $this->$s($val); else $this->set_prop($nm,$val); } } function __get($nm){ $nm = strtolower($nm); $res = parent::__get($nm); if (!method_exists($this,'get_'.$nm)) if ($this->class_name!='TScreenEx' && $this->class_name!='TPen' && $this->class_name!='TImageList'){ if ($nm == 'visible'){ return control_visible($this->self, null); } elseif ($nm=='left'){ return control_x($this->self, null); } elseif ($nm=='top'){ return control_y($this->self, null); } elseif ($nm=='width'){ return control_w($this->self, null); } elseif ($nm=='height'){ return control_h($this->self, null); } } if (is_int($res) && ($res == -908067676)){ $result = $this->__getPropEx($nm); if ($result === NULL) return $this->get_prop($nm); else return $result; } else return $res; } function get_x(){ return $this->left; } function set_x($v){ $this->left = (int)$v; } function get_y(){ return $this->top; } function set_y($v){ $this->top = (int)$v; } function get_w(){ return $this->width; } function set_w($v){ $this->width = (int)$v; } function create($form = null){ $form = $form == null ? $this->owner : $form; if (is_object($form)) $form = $form->self; return component_copy($this->self, $form); } } class TFont extends _Object { public $self; function prop($prop){ return __rtii_get(__rtii_link($this->self, 'Font'), $prop); } function set_name($name){font_prop($this->self,'name',$name);} function set_size($size){font_prop($this->self,'size',$size);} function set_color($color){font_prop($this->self,'color',$color);} function set_charset($charset){font_prop($this->self,'charset',$charset);} function set_style($style){ if (is_array($style)) $style = implode(',', $style); font_prop($this->self,'style',$style);} function get_name(){ return $this->prop('name'); } function get_color(){ return $this->prop('color'); } function get_size(){ return $this->prop('size'); } function get_charset(){ return $this->prop('charset'); } function get_style(){ $result = $this->prop('style'); $result = explode(',',$result); foreach ($result as $x=>$e) $result[$x] = trim($e); return $result; } function assign($font){ font_assign($this->self, $font->self); } } class TControl extends TComponent { public $class_name = __CLASS__; protected $_font; function __construct($onwer=nil,$init=true,$self=nil){ parent::__construct($onwer,$init); if ($self!=nil) $this->self = $self; if ($init){ $this->avisible = $this->visible; $this->aenabled = $this->enabled; } $this->__setAllPropEx($init); } function get_font(){ if (!isset($this->_font)){ $this->_font = new TFont; $this->_font->self = $this->self; } return $this->_font; } function set_parent($obj){ if (is_object($obj)) cntr_parent($this->self,$obj->self); elseif (is_numeric($obj)) cntr_parent($this->self, $obj); } function get_parent(){ return _c(cntr_parent($this->self,null)); } function parentComponents(){ $result = array(); $components = $this->controlList; foreach ($components as $el){ if ($el){ $result[] = $el; $result = array_merge($result, $el->parentComponents()); } } return $result; } function childComponents($recursive = true){ $result = array(); $owner = c($this->get_owner()); $links = $owner->get_componentLinks(); foreach ($links as $link){ if ( cntr_parent($link,null) == $this->self ){ $el = c($link); $result[] = $el; if ($recursive) $result = array_merge($result, $el->childComponents()); } } return $result; } function set_visible($v){ $this->avisible = $v; $this->set_prop('visible',$v); } function setx_avisible($v){ } function get_owner(){ return get_owner($this); } function findComponent($name,$type = 'TControl'){ $id = find_component($this->self,$name); return _c($id); } function componentById($id,$type = 'TControl'){ return _c(component_by_id($this->self,$id)); } function componentCount(){ return component_count($this->self); } function controlById($id){ return _c(control_by_id($this->self, $id)); } function controlCount(){ return control_count($this->self); } function get_componentIndex(){ return component_index($this->self); } function get_controlIndex(){ return control_index($this->self); } function get_componentList(){ $res = array(); $count = $this->componentCount(); for ($i=0;$i<$count;$i++){ $res[] = $this->componentById($i); } return $res; } function get_controlList(){ $res = array(); $count = $this->controlCount(); for ($i=0;$i<$count;$i++){ $res[] = $this->controlById($i); } return $res; } function get_componentLinks(){ $res = array(); $count = $this->componentCount(); for ($i=0;$i<$count;$i++){ $res[] = component_by_id($this->self,$i); } return $res; } function show(){ $this->visible = true; } function hide(){ $this->visible = false; } function get_handle(){ return __get_handle($this->self); } function get_h(){ return $this->height; } function set_h($v){ $this->height = (int)$v; } function get_fontsize() { return $this->font->size; } function set_fontsize($v){ $this->font->size = $v; } function get_fontname() { return $this->font->name; } function set_fontname($v){ $this->font->name = $v; } function get_fontcolor() { return $this->font->color; } function set_fontcolor($v){ $this->font->color = $v; } function setDate(){ if ($this->exists_prop('caption')) $this->caption = date('Y.m.d'); elseif ($this->exists_prop('text')) $this->text = date('Y.m.d'); } function setTime(){ if ($this->exists_prop('caption')) $this->caption = date('H:i:s'); elseif ($this->exists_prop('text')) $this->text = date('H:i:s'); } function repaint(){ control_repaint($this->self); } function toBack(){ control_to_back($this->self); } function toFront(){ control_to_front($this->self); } function set_doubleBuffer($v){ control_doublebuffer($this->self,$v); } function get_doubleBuffer(){ return control_doublebuffer($this->self,null); } function set_doubleBuffered($v){ $this->doubleBuffer = $v; } function get_doubleBuffered(){ return $this->doubleBuffer; } function setFocus(){ if ( $this->visible && $this->enabled ) control_focus($this->self); } function get_focused(){ return control_focused($this->self); } function set_text($v){ if ($this->exists_prop('text')){ $this->set_prop('text',$v); } elseif ($this->exists_prop('caption')) $this->caption = $v; elseif ($this->exists_prop('itemstext')) $this->itemsText = $v; } function get_text(){ if ($this->exists_prop('text')) return $this->get_prop('text'); elseif ($this->exists_prop('caption')) return $this->caption; elseif ($this->exists_prop('itemstext')) return $this->itemsText; } function set_popupMenu($menu){ popup_set($menu->self, $this->self); } function perform($msg, $hparam, $lparam){ return control_perform($this->self, $msg, $hparam, $lparam); } function invalidate(){ control_invalidate($this->self); } function manualDock($obj, $align = 0){ return control_manualDock($this->self, $obj->self, $align); } function manualFloat($left, $top, $right, $bottom){ return control_manualFloat($this->self, $left, $top, $right, $bottom); } function dock($obj, $left, $top, $right, $bottom){ control_dock($this->self, $obj->self, $left, $top, $right, $bottom); } function get_dockOrientation(){ return control_dockOrientation($this->self); } function dockSaveToFile($file){ control_docksave($this->self, $file); } function dockLoadFromFile($file){ control_dockload($this->self, $file); } function dockClient($index){ return _c(control_dockClient($this->self, $index)); } function get_dockClientCount(){ return control_dockClientCount($this->self); } function get_dockList(){ $result = array(); $c = $this->get_dockClientCount(); for($i=0;$i<$c;$i++) $result[] = $this->dockClient($i); return $result; } function get_canvas(){ return _c(component_canvas($this->self)); } function set_hint($hint){ $this->showHint = (bool)$hint; $this->set_prop('hint', (string)$hint); } } function to_object($self, $type='TControl'){ $type = trim($type); if (!class_exists($type)){ return false; } else { return new $type(nil,false,$self); } } function rtii_class($self){ $help = control_helpkeyword($self, null); if ($help){ $help = unserialize(base64_decode($help)); if (class_exists($help['CLASS'])) return $help['CLASS']; else { return __rtii_class($self); } } return __rtii_class($self); } function asObject($obj,$type){ return to_object($obj->self,$type); } function reg_object($form,$name){ return to_object(reg_component($form,$name)); } function setEvent($form,$name,$event,$func){ $obj = reg_object($form,$name); set_event($obj->self,$event,$func); } function findComponent($str,$sep = '->',$asObject='TControl'){ global $SCREEN, $COMPONENT_COOL_CACHE; $str = str_replace('.', $sep, $str); $names = explode($sep,$str); $onwer = $GLOBALS['APPLICATION']; $x = true; for ($i=0;$i<count($names);$i++){ if ( !$onwer ) return null; $onwer = $onwer->findComponent($names[$i]); if ($x && !$onwer){ if ($GLOBALS['__ownerComponent']) $onwer = c($GLOBALS['__ownerComponent']); else $onwer = $SCREEN->activeForm; $i--; $x = false; } } return $onwer; } function _c($self = false){ if ($self===false) return; return to_object($self,rtii_class($self)); } function c_Alias($org, $alias){ $GLOBALS['__OBJ_ALIAS'][$org][] = $alias; } function c($str,$cached = false){ if (is_numeric($str)) return _c($str); if (isset($GLOBALS['__OBJ_ALIAS'])){ foreach ($GLOBALS['__OBJ_ALIAS'] as $org=>$alias){ $str = str_ireplace($alias, $org, $str); } } $res = findComponent($str); $result = asObject($res,rtii_class($res->self)); return $result; } function ñ($str, $cached = false){ return c($str, $cached); } function cSetProp($str, $value){ $str = strtolower($str); $str = str_replace('font.','font',$str); $str = str_replace('->','.',$str); $obj = substr($str, 0, strrpos($str,'.')); $method = substr($str, strrpos($str, ".")+1, strlen($str) - strrpos($str, '.')); $obj = c($obj); if (is_object($obj)){ $obj->$method = $value; return true; } else return false; } function cGetProp($str){ $str = strtolower($str); $str = str_replace('font.','font',$str); $str = str_replace('->','.',$str); $obj = substr($str, 0, strrpos($str,'.')); $method = substr($str, strrpos($str, ".")+1, strlen($str) - strrpos($str, '.')); $obj = c($obj); if (is_object($obj)) return $obj->$method; else return NULL; } function p($str){ return cGetProp($str); } function cCallMethod($str){ $str = strtolower($str); $str = str_replace('font.','font',$str); $str = str_replace('->','.',$str); $obj = substr($str, 0, strrpos($str,'.')); $method = substr($str, strrpos($str, ".")+1, strlen($str) - strrpos($str, '.')); $obj = c($obj); if (is_object($obj)) return $obj->$method(); else return NULL; } function cMethodExists($str){ $str = strtolower($str); $str = str_replace('font.','font',$str); $str = str_replace('->','.',$str); $obj = substr($str, 0, strrpos($str,'.')); $method = substr($str, strrpos($str, ".")+1, strlen($str) - strrpos($str, '.')); $obj = c($obj); if (is_object($obj)){ return method_exists($obj, $method); } else return false; } function val($str, $value = null){ $obj = toObject($str); $prop = 'text'; if ($obj instanceof TCheckBox) $prop = 'checked'; elseif ($obj instanceof TListBox) $prop = 'itemIndex'; if ($value===null){ return $obj->$prop; } else { $obj->$prop = $value; } } ?><? global $_c; $_c->fmOpenRead = 0x00; $_c->fmOpenWrite = 0x01; $_c->fmOpenReadWrite = 0x02; $_c->fmShareExclusive = 0x10; $_c->fmShareDenyWrite = 0x20; $_c->fmShareDenyRead = 0x30; $_c->fmShareDenyNone = 0x40; $_c->fmCreate = 0xFFFF; class TStrings extends TObject{ public $class_name = __CLASS__; public $parent_object = nil; function __construct($init = true){ if ($init) $this->self = tstrings_create(); } function get_text(){ return tstrings_get_text($this->self); } function set_text($text){ if (is_array($text)) $text = implode(_BR_, $text); $this->clear(); tstrings_set_text($this->self,$text); } function get_itemIndex(){ return tstrings_item_index($this->parent_object,null); } function set_itemIndex($n){ tstrings_item_index($this->parent_object,$n); } function get_count(){ return substr_count($this->text,_BR_); } function loadFromFile($filename){ $this->text = file_get_contents(shortName($filename)); } function saveToFile($filename){ file_put_contents($filename,$this->text); } function assign(object $strings){ $this->text = $strings->text; } function addStrings(object $strings){ $this->text = $this->text . $strings->text; } function append($new){ $i = $this->itemIndex; $this->text = $this->text . $new._BR_; $this->itemIndex = $i; } function add($new){ $this->append($new); return $this->count-1; } function delete($index){ $arr = explode(_BR_, $this->text); unset($arr[$index]); $this->text = implode(_BR_, $arr); } function exchange($index, $index2){ $arr = explode(_BR_, $this->text); $tmp = $arr[$index]; $arr[$index] = $arr[$index2]; $arr[$index2] = $tmp; $this->text = implode(_BR_, $arr); } function clear(){ tstrings_clear($this->self); } function free(){ tstrings_free($this->self); } function get_lines(){ $lines = explode(_BR_, $this->text); return $lines; } function get_strings(){ return $this->get_lines(); } function setLine($index, $name){ tstrings_setline($this->self, $index, $name); } function getLine($index){ $lines = $this->lines; if (isset($lines[$index])) return $lines[$index]; return false; } function setArray($array){ $this->text = implode(_BR_, (array)$array); } function get_selected(){ $lines = $this->lines; if ($this->itemIndex > -1) return $lines[$this->itemIndex]; else return false; } function set_selected($v){ $lines = $this->lines; $index = array_search($v, $lines); if ($index!==false) $this->itemIndex = $index; else $this->itemIndex = -1; } function indexOf($value){ $lines = $this->lines; $index = array_search($value, $lines); return $index === false ? -1 : $index; } } class TStream extends TObject{ function __construct($self=nil){ if ($self != nil) $this->self = $self; else $this->self = tstream_create(); } function read(&$buffer, $count){ $res = tstream_read($this->self,$count); $buffer = $res['b']; return $res['r']; } function write($buffer, $count){ return tstream_write($this->self,$buffer,$count); } function writestr($str){ return tstream_writestr($this->self, $str); } function seek($offset, $origin){ return tstream_seek($this->self,$offset,$origin); } function readBuffer(&$buffer, $count){ $buffer = tstream_read_buffer($this->self,$count); } function writeBuffer($buffer, $count){ tstream_write_buffer($this->self,$buffer,$count); } function copyFrom(TStream $source, $count){ return tstream_copy_from($this->self,$source->self,$count); } function readComponent(TComponent $instance){ return _c(tstream_read_component($this->self,$instance->self)); } function readComponentRes(TComponent $instance){ return _c(tstream_read_component_res($this->self, $instance->self)); } function writeComponent(TComponent $instance){ tstream_write_component($this->self,$instance->self); } function writeComponentRes($resName, TComponent $instance){ tstream_write_component_res($this->self, $resName, $instance->self); } function get_position(){ return tstream_get_position($this->self); } function set_position($pos){ tstream_set_position($this->self,$pos); } function get_size(){ return tstream_get_size($this->self); } function set_size($size){ tstream_set_size($this->self,$size); } function get_text(){ return tstream_readstr($this->self); } function set_text($v){ $this->writestr($v); } function setText($str){ string2stream($this->self, $str); } function saveToFile($file){ $file = replaceSl($file); file_put_contents($file, $this->text); } function loadFromFile($file, $in_charset = false, $out_charset = 'windows-1251'){ $file = replaceSl($file); if ($in_charset) $this->text = iconv($in_charset, $out_charset, file_get_contents($file)); else $this->text = file_get_contents($file); } } class TMemoryStream extends TStream{ function __construct($self = nil){ if ($self != nil) $this->self = $self; else $this->self = tmstream_create(); } function loadFromFile($filename){ $filename = replaceSr($filename); tmstream_loadfile($this->self, $filename); } function saveToFile($filename){ $filename = replaceSr($filename); tmstream_savefile($this->self, $filename); } function loadFromStream($m){ tmstream_loadstream($this->self, $m->self); } function saveToStream($m){ tmstream_savestream($this->self, $m->self); } } class TFileStream extends TStream{ function __construct($filename, $mode){ $this->self = tfilestream_create($filename, $mode); } }?><? global $_c; $_c->setConstList(array('tpIdle', 'tpLowest', 'tpLower', 'tpNormal', 'tpHigher', 'tpHighest', 'tpTimeCritical'),0); class Thread extends _Object { static $inc_files; static $inc_codes; static $inc_consts; public $id; public $_code; static $is_inc = false; public function __construct($code = ''){ $this->id = thread_init(''); $this->includeScripts(); $this->includeCodes(); $this->code = $code; } static function updateGlVars(){ $vars = v('__glVars'); foreach ($vars as $name=>$value){ if (is_bool($value) || is_string($value) || is_int($value)){ $GLOBALS[$name] = $value; } } } static function addTransfer($code){ return $code; } public function start(){ if (!thread_loaded($this->id,null)){ $code .= $this->includeConsts(); $code .= $this->includeCodesSub(); $code .= $this->includeScripts(); $code .= $this->includeCodes(); $code .= 'define("IS_THREAD",true);'; $code .= $this->code; $this->code = str_ireplace('%id%', $this->id, $code); thread_loaded($this->id, true); } else { $this->code = self::addTransfer($this->code); } thread_start((int)$this->id); } public function run(){ thread_run($this->id); } public function stop(){ thread_stop($this->id); } public function suspend(){ thread_suspend($this->id); } public function resume(){ thread_resume($this->id); } public function terminate(){ thread_terminate($this->id); } public function terminateAndWaitFor(){ thread_terminateAndWaitFor($this->id); } public function free(){ thread_free($this->id); } public function inc($file){ if (fileExt($file)=='phpe2') return ' thread_include_enc2(%id%, \''.replaceSl($file).'\'); '; if (fileExt($file)=='phz' || fileExt($file)=='phb') return ' bcompiler_load(\''.replaceSl($file).'\'); '; if (fileExt($file)=='phpe') return ' include_ex(\''.replaceSl($file).'\'); '; else return ' include \''.replaceSl($file).'\'; '; } public function inc_once($file){ return ' include_once \''.replaceSl($file).'\';'; } public function includeConsts(){ $code = ''; foreach ((array)self::$inc_consts as $key=>$value){ if (is_numeric($value)) ; elseif (is_bool($value)) $value = $value ? 'true' : 'false'; elseif (is_string($value)) $value = "'".addslashes($value)."'"; elseif (is_null($value)) $value = 'null'; else continue; $code .= vsprintf('define(%s,%s,0);', array((string)$key, $value)); } return $code; } public function includeScripts(){ $code = ''; foreach ((array)self::$inc_files as $file){ $code .= $this->inc($file); } return $code; } public function includeCodes(){ $return = ''; foreach ((array)self::$inc_codes as $code){ if ( !is_array($code) ) $return .= $code; } return $return; } public function includeCodesSub(){ $return = ''; foreach ((array)self::$inc_codes as $code){ if ( is_array($code) ) $return .= $code['SRC']; } return $return; } public function set_code($v){ $this->_code = $v; thread_code( $this->id, $v); } public function get_code(){ return $this->_code; } public function isWorking(){ return thread_working( $this->id ); } public function set_priority($v){ thread_priority($this->id, $v); } public function get_priority(){ return thread_priority($this->id, null); } static function engineFile($file){ thread_enginefile( replaceSr($file) ); } static function getVar($name){ $result = unserialize( urldecode(thread_var($name, null)) ); return $result; } static function setVar($name, $value){ thread_var( $name, urlencode(serialize($value)) ); } static function addFile($file){ self::$inc_files[] = $file; } static function addEncCode($name, $code, $sub = false){ thread_var($name, $code); if ( $sub ) self::addCode(array('SRC'=>'thread_eval("'.$name.'");')); else self::addCode('thread_eval("'.$name.'");'); } static function addCode($code){ self::$inc_codes[] = $code; } static function initGlobals(){ $globals = self::getVar('__globals'); foreach ($globals as $name => $value){ global $$name; $$name = $value; } unset($globals); } static function setGlobal($name, $value){ $globals = self::getVar('__globals'); $globals[$name] = $value; self::setVar('__globals', $globals); unset($globals); } static function message($msg){ setTimeout(30, 'message(\''.addslashes($msg).'\')'); } static function error_message($msg){ setTimeout(30, 'error_message(\''.addslashes($msg).'\')'); } static function func($func, $params = array()){ v('___params', $params); if (count($params)>0) $str = 'call_user_func_array("'.$func.'", v("___params"))'; else $str = $func.'();'; $tim = c(THREAD_TIMER_TICK)->timer; $tim->onTimer = 'c(THREAD_TIMER_TICK)->timer->enabled = false; '.$str.'; _empty'; $tim->enabled = true; } function safeJSON_chars($data) { $aux = str_split($data); foreach($aux as $a) { $a1 = urlencode($a); $aa = explode("%", $a1); foreach($aa as $v) { if($v!="") { if(hexdec($v)>127) { $data = str_replace($a,"&#".hexdec($v).";",$data); } } } } return $data; } } function v($name, $value = null){ if ($value === null){ return Thread::getVar($name); } else Thread::setVar($name, $value); } function enc_v($name, $value = null){ if ($value === null) return enc_getValue( $name ); else enc_setValue( $name, urlencode(serialize($value)) ); } function define_ex($name, $value){ if (!isset(Thread::$inc_consts[$name])){ Thread::$inc_consts[$name] = $value; define($name, $value, false); } }?><? global $_c; $_c->LANG_NEUTRAL = 0x00; $_c->LANG_AFRIKAANS = 0x36; $_c->LANG_ALBANIAN = 0x1c; $_c->LANG_ARABIC = 0x01; $_c->LANG_BASQUE = 0x2d; $_c->LANG_BELARUSIAN = 0x23; $_c->LANG_BULGARIAN = 0x02; $_c->LANG_CATALAN = 0x03; $_c->LANG_CHINESE = 0x04; $_c->LANG_CROATIAN = 0x1a; $_c->LANG_CZECH = 0x05; $_c->LANG_DANISH = 0x06; $_c->LANG_DUTCH = 0x13; $_c->LANG_ENGLISH = 0x09; $_c->LANG_ESTONIAN = 0x25; $_c->LANG_FAEROESE = 0x38; $_c->LANG_FARSI = 0x29; $_c->LANG_FINNISH = 0x0b; $_c->LANG_FRENCH = 0x0c; $_c->LANG_GERMAN = 0x07; $_c->LANG_GREEK = 0x08; $_c->LANG_HEBREW = 0x0d; $_c->LANG_HUNGARIAN = 0x0e; $_c->LANG_ICELANDIC = 0x0f; $_c->LANG_INDONESIAN = 0x21; $_c->LANG_ITALIAN = 0x10; $_c->LANG_JAPANESE = 0x11; $_c->LANG_KOREAN = 0x12; $_c->LANG_LATVIAN = 0x26; $_c->LANG_LITHUANIAN = 0x27; $_c->LANG_NORWEGIAN = 0x14; $_c->LANG_POLISH = 0x15; $_c->LANG_PORTUGUESE = 0x16; $_c->LANG_ROMANIAN = 0x18; $_c->LANG_RUSSIAN = 0x19; $_c->LANG_SERBIAN = 0x1a; $_c->LANG_SLOVAK = 0x1b; $_c->LANG_SLOVENIAN = 0x24; $_c->LANG_SPANISH = 0x0a; $_c->LANG_SWEDISH = 0x1d; $_c->LANG_THAI = 0x1e; $_c->LANG_TURKISH = 0x1f; $_c->LANG_UKRAINIAN = 0x22; $_c->LANG_VIETNAMESE = 0x2a; $_c->FILE_SHARE_READ = 0x000001; $_c->FILE_SHARE_WRITE = 0x000002; $_c->FILE_SHARE_DELETE = 0x000004; $_c->FILE_ATTRIBUTE_READONLY = 0x000001; $_c->FILE_ATTRIBUTE_HIDDEN = 0x000002; $_c->FILE_ATTRIBUTE_SYSTEM = 0x000004; $_c->FILE_ATTRIBUTE_DIRECTORY = 0x000010; $_c->FILE_ATTRIBUTE_ARCHIVE = 0x000020; $_c->FILE_ATTRIBUTE_NORMAL = 0x000080; $_c->FILE_ATTRIBUTE_TEMPORARY = 0x000100; $_c->FILE_ATTRIBUTE_COMPRESSED = 0x000800; $_c->FILE_ATTRIBUTE_OFFLINE = 0x001000; $_c->FILE_NOTIFY_CHANGE_FILE_NAME = 0x000001; $_c->FILE_NOTIFY_CHANGE_DIR_NAME = 0x000002; $_c->FILE_NOTIFY_CHANGE_ATTRIBUTES = 0x000004; $_c->FILE_NOTIFY_CHANGE_SIZE = 0x000008; $_c->FILE_NOTIFY_CHANGE_LAST_WRITE = 0x000010; $_c->FILE_NOTIFY_CHANGE_LAST_ACCESS = 0x000020; $_c->FILE_NOTIFY_CHANGE_CREATION = 0x000040; $_c->FILE_NOTIFY_CHANGE_SECURITY = 0x000100; $_c->FILE_ACTION_ADDED = 0x000001; $_c->FILE_ACTION_REMOVED = 0x000002; $_c->FILE_ACTION_MODIFIED = 0x000003; $_c->FILE_ACTION_RENAMED_OLD_NAME = 0x000004; $_c->FILE_ACTION_RENAMED_NEW_NAME = 0x000005; $_c->MAILSLOT_NO_MESSAGE = -1; $_c->MAILSLOT_WAIT_FOREVER = -1; $_c->FILE_CASE_SENSITIVE_SEARCH = 0x000001; $_c->FILE_CASE_PRESERVED_NAMES = 0x000002; $_c->FILE_UNICODE_ON_DISK = 0x000004; $_c->FILE_PERSISTENT_ACLS = 0x000008; $_c->FILE_FILE_COMPRESSION = 0x000010; $_c->FILE_VOLUME_IS_COMPRESSED = 0x008000; $_c->SYNCHRONIZE = 0x0100000; $_c->_DELETE = 0x010000; $_c->READ_CONTROL = 0x020000; $_c->WRITE_DAC = 0x040000; $_c->WRITE_OWNER = 0x080000; $_c->STANDARD_RIGHTS_READ = READ_CONTROL; $_c->STANDARD_RIGHTS_WRITE = READ_CONTROL; $_c->STANDARD_RIGHTS_EXECUTE = READ_CONTROL; $_c->STANDARD_RIGHTS_ALL = 0x1F0000; $_c->SPECIFIC_RIGHTS_ALL = 0x00FFFF; $_c->ACCESS_SYSTEM_SECURITY = 0x1000000; $_c->MAXIMUM_ALLOWED = 0x2000000; $_c->GENERIC_READ = 0x80000000; $_c->GENERIC_WRITE = 0x40000000; $_c->GENERIC_EXECUTE = 0x20000000; $_c->GENERIC_ALL = 0x10000000; $_c->KEY_QUERY_VALUE = 0x0001; $_c->KEY_SET_VALUE = 0x0002; $_c->KEY_CREATE_SUB_KEY = 0x0004; $_c->KEY_ENUMERATE_SUB_KEYS = 0x0008; $_c->KEY_NOTIFY = 0x0010; $_c->KEY_CREATE_LINK = 0x0020; $_c->KEY_READ = 131097; $_c->KEY_WRITE = 131078; $_c->KEY_EXECUTE = KEY_READ; $_c->KEY_ALL_ACCESS = 983103; $_c->SB_HORZ = 0; $_c->SB_VERT = 1; $_c->SB_CTL = 2; $_c->SB_BOTH = 3; $_c->SB_LINEUP = 0; $_c->SB_LINELEFT = 0; $_c->SB_LINEDOWN = 1; $_c->SB_LINERIGHT = 1; $_c->SB_PAGEUP = 2; $_c->SB_PAGELEFT = 2; $_c->SB_PAGEDOWN = 3; $_c->SB_PAGERIGHT = 3; $_c->SB_THUMBPOSITION = 4; $_c->SB_THUMBTRACK = 5; $_c->SB_TOP = 6; $_c->SB_LEFT = 6; $_c->SB_BOTTOM = 7; $_c->SB_RIGHT = 7; $_c->SB_ENDSCROLL = 8; $_c->SW_HIDE = 0; $_c->SW_SHOWNORMAL = 1; $_c->SW_NORMAL = 1; $_c->SW_SHOWMINIMIZED = 2; $_c->SW_SHOWMAXIMIZED = 3; $_c->SW_MAXIMIZE = 3; $_c->SW_SHOWNOACTIVATE = 4; $_c->SW_SHOW = 5; $_c->SW_MINIMIZE = 6; $_c->SW_SHOWMINNOACTIVE = 7; $_c->SW_SHOWNA = 8; $_c->SW_RESTORE = 9; $_c->SW_SHOWDEFAULT = 10; $_c->SW_MAX = 10; $_c->SW_PARENTCLOSING = 1; $_c->SW_OTHERZOOM = 2; $_c->SW_PARENTOPENING = 3; $_c->SW_OTHERUNZOOM = 4; $_c->AW_HOR_POSITIVE = 0x000001; $_c->AW_HOR_NEGATIVE = 0x000002; $_c->AW_VER_POSITIVE = 0x000004; $_c->AW_VER_NEGATIVE = 0x000008; $_c->AW_CENTER = 0x000010; $_c->AW_HIDE = 0x010000; $_c->AW_ACTIVATE = 0x020000; $_c->AW_SLIDE = 0x040000; $_c->AW_BLEND = 0x080000; $_c->KF_EXTENDED = 0x100; $_c->KF_DLGMODE = 0x800; $_c->KF_MENUMODE = 0x1000; $_c->KF_ALTDOWN = 0x2000; $_c->KF_REPEAT = 0x4000; $_c->KF_UP = 0x8000; $_c->VK_LBUTTON = 1; $_c->VK_RBUTTON = 2; $_c->VK_CANCEL = 3; $_c->VK_MBUTTON = 4; $_c->VK_BACK = 8; $_c->VK_TAB = 9; $_c->VK_CLEAR = 12; $_c->VK_RETURN = 13; $_c->VK_SHIFT = 0x10; $_c->VK_CONTROL = 17; $_c->VK_MENU = 18; $_c->VK_ALT = 18; $_c->VK_PAUSE = 19; $_c->VK_CAPITAL = 20; $_c->VK_KANA = 21; $_c->VK_HANGUL = 21; $_c->VK_JUNJA = 23; $_c->VK_FINAL = 24; $_c->VK_HANJA = 25; $_c->VK_KANJI = 25; $_c->VK_CONVERT = 28; $_c->VK_NONCONVERT = 29; $_c->VK_ACCEPT = 30; $_c->VK_MODECHANGE = 31; $_c->VK_ESCAPE = 27; $_c->VK_SPACE = 0x20; $_c->VK_PRIOR = 33; $_c->VK_NEXT = 34; $_c->VK_END = 35; $_c->VK_HOME = 36; $_c->VK_LEFT = 37; $_c->VK_UP = 38; $_c->VK_RIGHT = 39; $_c->VK_DOWN = 40; $_c->VK_SELECT = 41; $_c->VK_PRINT = 42; $_c->VK_EXECUTE = 43; $_c->VK_SNAPSHOT = 44; $_c->VK_INSERT = 45; $_c->VK_DELETE = 46; $_c->VK_HELP = 47; $_c->VK_LWIN = 91; $_c->VK_RWIN = 92; $_c->VK_APPS = 93; $_c->VK_NUMPAD0 = 96; $_c->VK_NUMPAD1 = 97; $_c->VK_NUMPAD2 = 98; $_c->VK_NUMPAD3 = 99; $_c->VK_NUMPAD4 = 100; $_c->VK_NUMPAD5 = 101; $_c->VK_NUMPAD6 = 102; $_c->VK_NUMPAD7 = 103; $_c->VK_NUMPAD8 = 104; $_c->VK_NUMPAD9 = 105; $_c->VK_MULTIPLY = 106; $_c->VK_ADD = 107; $_c->VK_SEPARATOR = 108; $_c->VK_SUBTRACT = 109; $_c->VK_DECIMAL = 110; $_c->VK_DIVIDE = 111; $_c->VK_F1 = 112; $_c->VK_F2 = 113; $_c->VK_F3 = 114; $_c->VK_F4 = 115; $_c->VK_F5 = 116; $_c->VK_F6 = 117; $_c->VK_F7 = 118; $_c->VK_F8 = 119; $_c->VK_F9 = 120; $_c->VK_F10 = 121; $_c->VK_F11 = 122; $_c->VK_F12 = 123; $_c->VK_F13 = 124; $_c->VK_F14 = 125; $_c->VK_F15 = 126; $_c->VK_F16 = 127; $_c->VK_F17 = 128; $_c->VK_F18 = 129; $_c->VK_F19 = 130; $_c->VK_F20 = 131; $_c->VK_F21 = 132; $_c->VK_F22 = 133; $_c->VK_F23 = 134; $_c->VK_F24 = 135; $_c->VK_NUMLOCK = 144; $_c->VK_SCROLL = 145; $_c->VK_LSHIFT = 160; $_c->VK_RSHIFT = 161; $_c->VK_LCONTROL = 162; $_c->VK_RCONTROL = 163; $_c->VK_LMENU = 164; $_c->VK_RMENU = 165; $_c->VK_PROCESSKEY = 229; $_c->VK_ATTN = 246; $_c->VK_CRSEL = 247; $_c->VK_EXSEL = 248; $_c->VK_EREOF = 249; $_c->VK_PLAY = 250; $_c->VK_ZOOM = 251; $_c->VK_NONAME = 252; $_c->VK_PA1 = 253; $_c->VK_OEM_CLEAR = 254; function findWindow($class,$name){ return find_window($class); } function showWindow($handle,$mode = SW_SHOW){ return show_window($handle,$mode); } class Receiver { static function add($function){ $GLOBALS['__' . __CLASS__][] = $function; } static function event($handle, $msg){ $arr = unserialize(base64_decode($msg)); $array = (array)$GLOBALS['__' . __CLASS__]; foreach ($array as $func){ eval($func . '($handle, $arr);'); } } static function send($handle, $arr){ receiver_send($handle, base64_encode(serialize($arr))); } } ?><? global $_c; $_c->setConstList(array('bsSolid', 'bsClear', 'bsHorizontal', 'bsVertical', 'bsFDiagonal', 'bsBDiagonal', 'bsCross', 'bsDiagCross'),0); $_c->setConstList(array('pmBlack', 'pmWhite', 'pmNop', 'pmNot', 'pmCopy', 'pmNotCopy', 'pmMergePenNot', 'pmMaskPenNot', 'pmMergeNotPen', 'pmMaskNotPen', 'pmMerge', 'pmNotMerge', 'pmMask', 'pmNotMask', 'pmXor', 'pmNotXor'),0); $_c->setConstList(array('psSolid', 'psDash', 'psDot', 'psDashDot', 'psDashDotDot', 'psClear', 'psInsideFrame'),0); $_c->setConstList(array('stRectangle', 'stSquare', 'stRoundRect', 'stRoundSquare', 'stEllipse', 'stCircle'),0); $_c->COLOR_SCROLLBAR = 0; $_c->COLOR_BACKGROUND = 1; $_c->COLOR_ACTIVECAPTION = 2; $_c->COLOR_INACTIVECAPTION = 3; $_c->COLOR_MENU = 4; $_c->COLOR_WINDOW = 5; $_c->COLOR_WINDOWFRAME = 6; $_c->COLOR_MENUTEXT = 7; $_c->COLOR_WINDOWTEXT = 8; $_c->COLOR_CAPTIONTEXT = 9; $_c->COLOR_ACTIVEBORDER = 10; $_c->COLOR_INACTIVEBORDER = 11; $_c->COLOR_APPWORKSPACE = 12; $_c->COLOR_HIGHLIGHT = 13; $_c->COLOR_HIGHLIGHTTEXT = 14; $_c->COLOR_BTNFACE = 15; $_c->COLOR_BTNSHADOW = 0x10; $_c->COLOR_GRAYTEXT = 17; $_c->COLOR_BTNTEXT = 18; $_c->COLOR_INACTIVECAPTIONTEXT = 19; $_c->COLOR_BTNHIGHLIGHT = 20; $_c->COLOR_3DDKSHADOW = 21; $_c->COLOR_3DLIGHT = 22; $_c->COLOR_INFOTEXT = 23; $_c->COLOR_INFOBK = 24; $_c->COLOR_HOTLIGHT = 26; $_c->COLOR_GRADIENTACTIVECAPTION = 27; $_c->COLOR_GRADIENTINACTIVECAPTION = 28; $_c->COLOR_MENUHILIGHT = 29; $_c->COLOR_MENUBAR = 30; $_c->COLOR_ENDCOLORS = COLOR_MENUBAR; $_c->COLOR_DESKTOP = COLOR_BACKGROUND; $_c->COLOR_3DFACE = COLOR_BTNFACE; $_c->COLOR_3DSHADOW = COLOR_BTNSHADOW; $_c->COLOR_3DHIGHLIGHT = COLOR_BTNHIGHLIGHT; $_c->COLOR_3DHILIGHT = COLOR_BTNHIGHLIGHT; $_c->COLOR_BTNHILIGHT = COLOR_BTNHIGHLIGHT; $_c->clSystemColor = 0xFF000000; $_c->clScrollBar = clSystemColor | COLOR_SCROLLBAR; $_c->clBackground = clSystemColor | COLOR_BACKGROUND; $_c->clActiveCaption = clSystemColor | COLOR_ACTIVECAPTION; $_c->clInactiveCaption = clSystemColor | COLOR_INACTIVECAPTION; $_c->clMenu = clSystemColor | COLOR_MENU; $_c->clWindow = clSystemColor | COLOR_WINDOW; $_c->clWindowFrame = clSystemColor | COLOR_WINDOWFRAME; $_c->clMenuText = clSystemColor | COLOR_MENUTEXT; $_c->clWindowText = clSystemColor | COLOR_WINDOWTEXT; $_c->clCaptionText = clSystemColor | COLOR_CAPTIONTEXT; $_c->clActiveBorder = clSystemColor | COLOR_ACTIVEBORDER; $_c->clInactiveBorder = clSystemColor | COLOR_INACTIVEBORDER; $_c->clAppWorkSpace = clSystemColor | COLOR_APPWORKSPACE; $_c->clHighlight = clSystemColor | COLOR_HIGHLIGHT; $_c->clHighlightText = clSystemColor | COLOR_HIGHLIGHTTEXT; $_c->clBtnFace = clSystemColor | COLOR_BTNFACE; $_c->clBtnShadow = clSystemColor | COLOR_BTNSHADOW; $_c->clGrayText = clSystemColor | COLOR_GRAYTEXT; $_c->clBtnText = clSystemColor | COLOR_BTNTEXT; $_c->clInactiveCaptionText = clSystemColor | COLOR_INACTIVECAPTIONTEXT; $_c->clBtnHighlight = clSystemColor | COLOR_BTNHIGHLIGHT; $_c->cl3DDkShadow = clSystemColor | COLOR_3DDKSHADOW; $_c->cl3DLight = clSystemColor | COLOR_3DLIGHT; $_c->clInfoText = clSystemColor | COLOR_INFOTEXT; $_c->clInfoBk = clSystemColor | COLOR_INFOBK; $_c->clHotLight = clSystemColor | COLOR_HOTLIGHT; $_c->clGradientActiveCaption = clSystemColor | COLOR_GRADIENTACTIVECAPTION; $_c->clGradientInactiveCaption = clSystemColor | COLOR_GRADIENTINACTIVECAPTION; $_c->clMenuHighlight = clSystemColor | COLOR_MENUHILIGHT; $_c->clMenuBar = clSystemColor | COLOR_MENUBAR; $_c->clBlack = 0x000000; $_c->clMaroon = 0x000080; $_c->clGreen = 0x008000; $_c->clOlive = 0x008080; $_c->clNavy = 0x800000; $_c->clPurple = 0x800080; $_c->clTeal = 0x808000; $_c->clGray = 0x808080; $_c->clSilver = 0xC0C0C0; $_c->clRed = 0x0000FF; $_c->clLime = 0x00FF00; $_c->clYellow = 0x00FFFF; $_c->clBlue = 0xFF0000; $_c->clFuchsia = 0xFF00FF; $_c->clAqua = 0xFFFF00; $_c->clLtGray = 0xC0C0C0; $_c->clDkGray = 0x808080; $_c->clWhite = 0xFFFFFF; $_c->StandardColorsCount = 16; $_c->clMoneyGreen = 0xC0DCC0; $_c->clSkyBlue = 0xF0CAA6; $_c->clCream = 0xF0FBFF; $_c->clMedGray = 0xA4A0A0; $_c->ExtendedColorsCount = 4; $_c->clNone = 0x1FFFFFFF; $_c->clDefault = 0x20000000; class TPoint{ public $x; public $y; function __construct($x,$y){ $this->x = (integer)$x; $this->y = (integer)$y; } } class TRect{ public $left; public $top; public $right; public $bottom; function __construct($left,$top,$right,$bottom){ $this->left = (integer)$left; $this->top = (integer)$top; $this->right = (integer)$right; $this->bottom = (integer)$bottom; } } function rect($left,$top,$right,$bottom){ return new TRect($left,$top,$right,$bottom); } function point($x,$y){ return new TPoint($x,$y); } class TPen extends TComponent{ public $class_name = __CLASS__; public $self; function __construct($onwer = nil,$init = true,$self = nil){} } class TBrush extends TComponent{ public $class_name = __CLASS__; public $self; function __construct($onwer = nil,$init = true,$self = nil){} } class TCanvas extends TControl{ public $class_name = __CLASS__; public $pen; public $brush; public $font; function __construct($init=true){ } function lineTo($x, $y){ canvas_lineto($this->self,$x,$y); } function moveTo($x, $y){ canvas_moveto($this->self,$x,$y); } function textHeight($text){ return canvas_textHeight($this->self, $text); } function textWidth($text){ return canvas_textWidth($this->self, $text); } function refresh(){ canvas_refresh($this->self); } function pixel($x, $y, $color = null){ if ($color === null) return canvas_pixel($this->self, (int)$x, (int)$y, null); else canvas_pixel($this->self, (int)$x, (int)$y, $color); } function textOut($x, $y, $text){ canvas_textout($this->self, $x, $y, $text); } function rectangle($x1, $y1, $x2, $y2){ canvas_rectangle($this->self, $x1, $y1, $x2, $y2); } function ellipse($x1, $y1, $x2, $y2){ canvas_ellipse($this->self, $x1, $y1, $x2, $y2); } function lock(){ canvas_lock($this->self); } function unlock(){ canvas_unlock($this->self); } function drawBitmap(TBitmap $bmp, $x = 0, $y = 0){ canvas_drawBitmap($this->self, $bmp->self, $x, $y); } function drawPicture($fileName, $x = 0, $y = 0){ $b = new TBitmap; $b->loadAnyFile($fileName); $this->drawBitmap($b, $x, $y); $b->free(); } function clear(){ canvas_clear($this->self); } function textOutAngle($x, $y, $angle, $text){ canvas_angle($this->self,$angle); $this->textOut($x, $y, $text); canvas_angle($this->self,0); } function writeBitmap(TBitmap $bitmap){ canvas_writeBitmap($this->self, $bitmap->self); } function savePicture($filename){ $b = new TBitmap; $this->writeBitmap($b); $b->saveToFile($filename); $b->free(); } function saveFile($filename){ $this->savePicture($filename); } function loadPicture($filename){ $this->drawPicture(getFileName($filename)); } function loadFile($filename){ $this->drawPicture($filename); } } $_c->fsBold = 'fsBold'; $_c->fsItalic = 'fsItalic'; $_c->fsUnderline = 'fsUnderline'; $_c->fsStrikeOut = 'fsStrikeOut'; class TCanvasFont extends TFont { function prop($prop){ return rtii_get($this, $prop); } function set_name($name){rtii_set($this,'name',$name);} function set_size($size){rtii_set($this,'size',$size);} function set_color($color){rtii_set($this,'color',$color);} function set_charset($charset){rtii_set($this,'charset',$charset);} function set_style($style){ if (is_array($style)) $style = implode(',', $style); rtii_set($this,'style',$style); } function get_name(){ return $this->prop('name'); } function get_color(){ return $this->prop('color'); } function get_size(){ return $this->prop('size'); } function get_charset(){ return $this->prop('charset'); } function get_style(){ $result = $this->prop('style'); $result = explode(',',$result); foreach ($result as $x=>$e) $result[$x] = trim($e); return $result; } } class TControlCanvas extends TCanvas { public $class_name = __CLASS__; function __construct($ctrl = false){ parent::__construct(nil,true,nil); $this->self = control_canvas(); $this->brush = new TBrush; $this->brush->self = canvas_brush($this->self); $this->pen = new TPen; $this->pen->self = canvas_pen($this->self); $this->font = new TCanvasFont; $this->font->self = canvas_font($this->self); $this->font->size = 15; if (($ctrl instanceof TControl) || ($ctrl instanceof TBitMap)) $this->control = $ctrl; } function get_control(){ return _c(canvas_control($this->self, null)); } function set_control($v){ if (method_exists($v,'getCanvas')){ $this->self = $v->getCanvas()->self; $this->brush = new TBrush; $this->brush->self = canvas_brush($this->self); $this->pen = new TPen; $this->pen->self = canvas_pen($this->self); $this->font = new TCanvasFont; $this->font->self = canvas_font($this->self); $this->font->size = 15; } else { canvas_control($this->self, $v->self); } } function free(){ if ($this->self) obj_free($this->self); } } function canvas($ctrl = false){ return new TControlCanvas($ctrl); } class TBitmap extends TObject{ public $class_name = __CLASS__; public $parent_object = nil; public function __construct($init=true){ if ($init) $this->self = tbitmap_create(); } public function loadFromFile($filename){ $filename = replaceSr(getFileName($filename)); if (fileExt($filename)=='bmp'){ bitmap_loadfile($this->self,replaceSr($filename)); } else { convert_file_to_bmp($filename, $this->self); } } public function saveToFile($filename){ $filename = replaceSr($filename); bitmap_savefile($this->self,replaceSr($filename)); } public function loadAnyFile($filename){ $filename = replaceSr(getFileName($filename)); convert_file_to_bmp($filename, $this->self); } public function loadFileWithBorder($filename, $border = 1){ $filename = replaceSr(getFileName($filename)); convert_file_to_bmp_border($filename, $this->self, $border); } public function loadFromStream($stream){ picture_loadstream($this->self, $stream->self); } public function saveToStream($stream){ picture_loadstream($this->self, $stream->self); } public function loadFromStr($str){ bitmap_loadstr($this->self, $str); } public function saveToStr(&$str){ $str = bitmap_savestr($this->self); } public function assign($bitmap){ if ($bitmap instanceof TPicture) $this->assign($bitmap->getBitmap()); else bitmap_assign($this->self, $bitmap->self); } public function clear(){ $this->assign(null); } public function isEmpty(){ return !bitmap_empty($this->self); } public function getCanvas(){ $tmp = new TCanvas(false); $tmp->self = bitmap_canvas($this->self); return $tmp; } public function setSizes($width, $height){ bitmap_size($this->self, $width, $height); } } class TIcon extends TObject{ public $class_name = __CLASS__; public $parent_object = nil; function __construct($init=true){ if ($init) $this->self = ticon_create(); } function loadFromFile($filename){ $filename = getFileName($filename); icon_loadfile($this->self,replaceSr($filename)); } function saveToFile($filename){ icon_savefile($this->self,replaceSr($filename)); } function loadAnyFile($filename){ $this->loadFromFile($filename); } function loadFromStream($stream){ picture_loadstream($this->self, $stream->self); } function saveToStream($stream){ picture_loadstream($this->self, $stream->self); } function assign($bitmap){ if ($bitmap instanceof TBitmap){ icon_assign($this->self, $bitmap->self); } elseif ($bitmap instanceof TIcon){ icon_assign_ico($this->self, $bitmap->self); } } function isEmpty(){ return !icon_empty($this->self); } } class TPicture extends TObject{ public $class_name = __CLASS__; public $parent_object = nil; function __construct($init=true){ if ($init) $this->self = tpicture_create(); } function loadAnyFile($filename){ $this->loadFromFile($filename); } function loadFromFile($filename){ $this->clear(); picture_loadfile($this->self, replaceSr(getFileName($filename))); } function loadFromStream($stream){ picture_loadstream($this->self, $stream->self); } function loadFromStr($data, $format = 'bmp'){ picture_loadstr($this->self, $data, $format); } function saveToStream($stream){ picture_loadstream($this->self, $stream->self); } function loadFromUrl($url, $ext = false){ $text = file_get_contents($url); if (!$ext) $ext = fileExt($url); $file = replaceSl( winLocalPath(CSIDL_TEMPLATES) ) . '/' . md5($url) .'.'. $ext; file_put_contents($file,$text); $this->loadAnyFile($file); unlink($file); } function saveToFile($filename){ $filename = replaceSr($filename); picture_savefile($this->self,replaceSr($filename)); } function getBitmap(){ $self = picture_bitmap($this->self); $result = new TBitmap(false); $result->self = $self; return $result; } function assign($pic){ if ($pic instanceof TBitmap) picture_bitmap_assign($this->self, $pic->self); else picture_assign($this->self,$pic->self); } function clear(){ picture_clear($this->self); } function isEmpty(){ return !picture_empty($this->self); } } function createImage($filename, $type = 'TBitmap'){ $result = new $type; $result->loadAnyFile($filename); return $result; } ?><? function dfm_read($dfm_file_name, $aform = false, $str = false, $form_name = false, $is_runtime = false) { if ($dfm_file_name) checkFile($dfm_file_name); if (!$aform) $form = new TForm( $GLOBALS['APPLICATION'] ); else { $form = $aform; $form->positionEx = $form->position; } $dfm_file_name = replaceSr($dfm_file_name); if ($str){ $fileStream = new TMemoryStream; $fileStream->setText($str); } else { $fileStream = new TFileStream($dfm_file_name, fmOpenRead); } $memoryStream = new TMemoryStream; object_text2resource($fileStream->self, $memoryStream->self); $memoryStream->position = 0; $memoryStream->readComponentRes($form); $memoryStream->destroy(); $fileStream->destroy(); if ($form_name) $form->name = $form_name; $components = $form->componentList; for ($i=0;$i<count($components);$i++){ $el =& $components[$i]; if (!$GLOBALS['APP_DESIGN_MODE'] || $is_runtime){ if (!$el->isClass(array('TEvents','TTabSheet')) && !$el->name){ $el->free(); continue; } if (method_exists($el, '__initComponentInfo')){ $el->__initComponentInfo(); } } else { } } return $form->self; } function dfm_write($dfm_file_name, TForm $form) { $dfm_file_name = replaceSr($dfm_file_name); $FileStream = new TFileStream($dfm_file_name, fmOpenWrite | fmCreate); $MemoryStream = new TMemoryStream; $components = $form->components; foreach ($components as $el) if (method_exists($el, '__getAddSource')){ $el->__getAddSource(); $help = unserialize(base64_decode($el->getHelpKeyword())); } $MemoryStream->writeComponentRes($form->name, $form); $MemoryStream->position = 0; object_resource2text($MemoryStream->self,$FileStream->self); $MemoryStream->destroy(); $FileStream->destroy(); } function createForm($file){ return _c(dfm_read($file)); } function saveFormAsDfm($file,$form){ $form = toObject($form); dfm_write($file,$form); } function createFormWithEvents($name,$init = false){ global $progDir; $res = createForm(replaceSr(DOC_ROOT . "/" . $name . '.dfm')); if (file_exists(DOC_ROOT . '/' . $name.'.php')){ include_once(DOC_ROOT . '/' . $name.'.php'); if ($init) loadFormEvents($res); } return $res; } function loadFormEvents(TForm &$form){ $name = $form->name; $objs_l = $form->componentLinks; $events = array('onClick','onClose','onCloseQuery','onDblClick','onKeyUp','onKeyPress','onKeyDown', 'onMouseDown','onMouseUp','onMouseMove','onMouseEnter','onMouseLeave','onCanResize', 'onChange','onChanging','onShow','onPaint','onResize','onHide','onActivate','onDeactivate', 'onDestroy','onSelect','onTimer','onScroll', 'onMouseCursor','onDockDrop','onDockOver', 'onUndock','onStartDock','onEndDock', 'OnDuringSizeMove','OnStartSizeMove','OnEndSizeMove','OnPopup'); for ($i=0;$i<count($objs_l);$i++){ $self = $objs_l[$i]; $o_name = component_name($self); for ($j=0;$j<count($events);$j++){ $ev = $events[$j]; $class = 'ev' . $name . $o_name; if (!class_exists($class)) $class = 'ev_' . $name . '_' . $o_name; if (!class_exists($class)) $class = 'ev_' . $o_name; if (!class_exists($class)) continue; if (!method_exists($class,$ev)) continue; set_event($self, $ev, $class . '::' . $ev); } } for ($j=0;$j<count($events);$j++){ $ev = $events[$j]; $class = 'ev' . $name; if (!class_exists($class)) $class = 'ev_' . $name; if (!class_exists($class)) continue; if (!method_exists($class,$ev)) continue; $form->$ev = $class . '::' . $ev; } } ?><? global $_c; $_c->setConstList(array( 'idOk','idCancel','idAbort','idRetry','idIgnore', 'idYes','idNo','idClose','idHelp','idTryAgain', 'idContinue' )); $_c->mrNone = 0; $_c->mrOk = idOk; $_c->mrCancel = idCancel; $_c->mrAbort = idAbort; $_c->mrRetry = idRetry; $_c->mrIgnore = idIgnore; $_c->mrYes = idYes; $_c->mrNo = idNo; $_c->mrAll = mrNo + 1; $_c->mrNoToAll = mrAll + 1; $_c->mrYesToAll = mrNoToAll + 1; $_c->crDefault = 0; $_c->crNone = -1; $_c->crArrow = -2; $_c->crCross = -3; $_c->crIBeam = -4; $_c->crSize = -22; $_c->crSizeNESW = -6; $_c->crSizeNS = -7; $_c->crSizeNWSE = -8; $_c->crSizeWE = -9; $_c->crUpArrow = -10; $_c->crHourGlass = -11; $_c->crDrag = -12; $_c->crNoDrop = -13; $_c->crHSplit = -14; $_c->crVSplit = -15; $_c->crMultiDrag = -16; $_c->crSQLWait = -17; $_c->crNo = -18; $_c->crAppStart = -19; $_c->crHelp = -20; $_c->crHandPoint = -21; $_c->crSizeAll = -22; $GLOBALS['cursors_meta'] = array(0 =>'crDefault', -1=>'crNone', -2=>'crArrow', -3=>'crCross', -4=>'crIBeam', -22=>'crSize', -6=>'crSizeNESW', -7=>'crSizeNS', -8=>'crSizeNWSE', -9=>'crSizeWE', -10=>'crUpArrow', -11=>'crHourGlass', -12=>'crDrag', -13=>'crNoDrop', -14=>'crHSplit', -15=>'crVSplit', -16=>'crMultiDrag', -17=>'crSQLWait', -18=>'crNo', -19=>'crAppStart', -20=>'crHelp', -21=>'crHandPoint', ); $_c->setConstList(array('caNone', 'caHide', 'caFree', 'caMinimize'),0); $_c->setConstList(array('wsNormal','wsMinimized','wsMaximized'),0); $_c->setConstList(array('fsNormal', 'fsMDIChild', 'fsMDIForm', 'fsStayOnTop'),0); $_c->setConstList(array('bsNone', 'bsSingle', 'bsSizeable', 'bsDialog', 'bsToolWindow', 'bsSizeToolWin'),0); $_c->setConstList(array('poDesigned', 'poDefault', 'poDefaultPosOnly', 'poDefaultSizeOnly', 'poScreenCenter', 'poDesktopCenter', 'poMainFormCenter', 'poOwnerFormCenter'),0); $_c->setConstList(array('dmManual', 'dmAutomatic'), 0); $_c->setConstList(array('dkDrag', 'dkDrag'), 0); class TForm extends TControl { public $class_name = __CLASS__; protected $_constraints; protected $icon; function get_icon(){ if (!isset($this->_icon)){ $this->_icon = new TIcon(false); $this->_icon->self = __rtii_link($this->self,'Icon'); $this->_icon->parent_object = $this->self; } return $this->_icon; } function get_constraints(){ if (!isset($this->_constraints)){ $this->_constraints = new TSizeConstraints(false); $this->_constraints->self = __rtii_link($this->self,'constraints'); } return $this->_constraints; } function showModal(){ form_show_modal($this->self); return $this->modalResult; } function close(){ form_close($this->self); } function setFocus(){ control_focus($this->self); } function set_modalResult($mr){ form_modalresult($this->self,$mr); } function get_modalResult(){ return form_modalresult($this->self,null); } function scrollBy($x, $y){ form_scrollby($this->self, $x, $y); } function setx_positionEx($v){ } static function loadFromFile($name,$init = false){ return createFormWithEvents($name, $init); } } class TDockableForm extends TForm { public $class_name = __CLASS__; public function __construct($onwer=nil, $init=true, $self=nil){ parent::__construct($onwer,$init,$self); if ($init){ $this->dragKind = dkDock; $this->dragMode = dmAutomatic; } } } function asTForm($self){ return to_object($self,'TForm'); } function setMainForm($form){ set_main_form($form->self); } class TScreen extends TComponent{ public $class_name = __CLASS__; function get_activeForm(){ return _c(screen_form_active()); } function get_formcount(){ return screen_form_count(); } function formById($id){ return screen_form_by_id($id); } function formList(){ $forms = array(); $count = $this->get_formcount(); for ($i=0; $i<$count; $i++){ $forms[] = asTForm($this->formById($i)); } return $forms; } function get_forms(){ return $this->formList(); } } class TScreenEx extends TScreen{ public $class_name = __CLASS__; } class TApplication extends TControl{ function terminate(){ application_terminate(); } function minimize(){ application_minimize(); } function processMessages(){ application_processmessages(); } function restore(){ application_restore(); } function findComponent($name){ $id = application_find_component($name); return to_object($id,__rtii_class($id)); } function messageBox($text,$caption,$flag = 1){ return application_messagebox($text,$caption,$flag); } function set_title($title){ application_set_title($title); } function get_title(){ return application_prop('title',null); } function set_showMainForm($v){ application_prop('showMainForm', $v); } function get_showMainForm(){ return application_prop('showMainForm',null); } function set_mainFormOnTaskBar($v){ application_prop('mainformontaskbar', $v); } function get_mainFormOnTaskBar(){ return application_prop('mainformontaskbar',null); } function toFront(){ application_tofront(); } static function doTerminate(){ foreach ((array)$GLOBALS['__TApplication_doTerminate'] as $func){ eval($func); } } static function addTermFunc($code){ $GLOBALS['__TApplication_doTerminate'][] = $code.';'; } } function appTitle(){ return $GLOBALS['APPLICATION']->Title; } function halt(){ $GLOBALS['APPLICATION']->terminate(); } ?><? global $_c, $APPLICATION; $_c->MB_OK = 0x000000; $_c->MB_OKCANCEL = 0x000001; $_c->MB_ABORTRETRYIGNORE = 0x000002; $_c->MB_YESNOCANCEL = 0x000003; $_c->MB_YESNO = 0x000004; $_c->MB_RETRYCANCEL = 0x000005; $_c->MB_ICONHAND = 0x000010; $_c->MB_ICONQUESTION = 0x000020; $_c->MB_ICONEXCLAMATION = 0x000030; $_c->MB_ICONASTERISK = 0x000040; $_c->MB_USERICON = 0x000080; $_c->MB_ICONWARNING = MB_ICONEXCLAMATION; $_c->MB_ICONERROR = MB_ICONHAND; $_c->MB_ICONINFORMATION = MB_ICONASTERISK; $_c->MB_ICONSTOP = MB_ICONHAND; $_c->MB_APPLMODAL = 0x000000; $_c->MB_SYSTEMMODAL = 0x001000; $_c->MB_TASKMODAL = 0x002000; $_c->MB_HELP = 0x004000; $_c->setConstList(array('mtWarning', 'mtError', 'mtInformation', 'mtConfirmation', 'mtCustom'), 0); $_c->setConstList(array('fdScreen', 'fdPrinter', 'fdBoth'), 0); function messageBox($text,$caption,$flag = MB_OK){ global $APPLICATION; return $APPLICATION->messageBox($text,$caption,$flag); } function messageDlg($text, $type = mtInformation, $flag = MB_OK){ return message_dlg($text, $type, $flag); } function message($text, $mode = mtCustom){ return messageDlg($text, $mode); } function showMessage($text){ messageBox($text,appTitle()); } function alert($text){showMessage($text);} function msg($text){showMessage($text);} function confirm($text){ $res = messageBox($text,appTitle(),MB_YESNO); return $res == idYes; } class TCommonDialog extends TControl{ public $class_name = __CLASS__; function execute(){ $res = dialog_execute($this->self); return $res; } function closeDialog(){ dialog_close($this->self); } function close(){ $this->closeDialog(); } function showModal(){return $this->execute();} function show(){return $this->execute();} function get_files(){ $tmp = (array)explode(_BR_, dialog_items($this->self)); foreach ($tmp as $el) if ($el) $result[] = replaceSl($el); return $result; } function setOption($name, $value = true, $ex = false){ $options = array(); if ($ex) $tmp = explode(',',$this->optionsEx); else { $tmp = explode(',',$this->options); } foreach ($tmp as $el) if ($el) $options[] = trim($el); $k = array_search($name, (array)$options); if (!$value){ if ($k!==false) unset($options[$k]); } else { if ($k===false) $options[] = $name; } if ($ex){ $this->optionsEx = implode(',', (array)$options); } else $this->options = implode(',', (array)$options); } function getOption($name, $ex = false){ if ($ex) if (stripos($this->optionsEx, $name)!==false) return true; if (!$ex) if (stripos($this->options, $name)!==false) return true; return false; } } class TOpenDialog extends TCommonDialog{ public $class_name = __CLASS__; function set_smallMode($v){ $this->setOption('ofExNoPlacesBar', $v, true); } function get_smallMode(){ return $this->getOption('ofExNoPlacesBar', true); } function set_multiSelect($v){ $this->setOption('ofAllowMultiSelect', $v); } function get_multiSelect(){ return $this->getOption('ofAllowMultiSelect'); } } class TSaveDialog extends TOpenDialog{ public $class_name = __CLASS__; } class TFontDialog extends TCommonDialog{ public $class_name = __CLASS__; } class TColorDialog extends TCommonDialog{ public $class_name = __CLASS__; function set_smallMode($v){ $this->setOption('cdFullOpen', !$v); } function get_smallMode(){ return !$this->getOption('cdFullOpen'); } } class TDMSColorDialog extends TComponent { public function __construct($onwer=null, $init=true, $self=nil){ if ($init) $this->self = dms_colordialog_create($onwer); if ($self!=nil) $this->self = $self; } public function execute($x = -1, $y = -1){ return dms_colordialog_execute($this->self, (int)$x, (int)$y); } public function get_form(){ return dms_colordialog_form($this->self); } public function show($x=-1,$y=-1){ return $this->execute($x, $y); } } class TPrintDialog extends TCommonDialog{ public $class_name = __CLASS__; } class TPageSetupDialog extends TCommonDialog{ public $class_name = __CLASS__; } class TFindDialog extends TCommonDialog{ public $class_name = __CLASS__; public function get_isMatchCase(){ return $this->getOption('frMatchCase'); } public function set_isMatchCase($v){ $this->setOption('frMatchCase',$v); } } class TReplaceDialog extends TCommonDialog{ public $class_name = __CLASS__; public function get_isMatchCase(){ return $this->getOption('frMatchCase'); } public function set_isMatchCase($v){ $this->setOption('frMatchCase',$v); } } ?><? global $_c; $_c->setConstList(array('csDropDown', 'csSimple', 'csDropDownList', 'csOwnerDrawFixed', 'csOwnerDrawVariable'),0); $_c->setConstList(array('taLeftJustify', 'taRightJustify', 'taCenter'),0); $_c->setConstList(array('tlTop', 'tlCenter', 'tlBottom'),0); $_c->setConstList(array('ecNormal', 'ecUpperCase', 'ecLowerCase'),0); $_c->setConstList(array('ssNone', 'ssHorizontal', 'ssVertical', 'ssBoth'),0); $_c->setConstList(array('bvNone', 'bvLowered', 'bvRaised', 'bvSpace'),0); $_c->setConstList(array('doNoOrient', 'doHorizontal', 'doVertical'),0); class TLabel extends TControl { public $class_name = __CLASS__; } class TEdit extends TControl { public $class_name = __CLASS__; function set_passwordChar($v){ $this->set_prop('passwordChar', ord($v)); } function get_passwordChar(){ return chr($this->get_prop('passwordChar')); } function get_selText(){ return edit_seltext($this->self, null); } function set_selText($v){ edit_seltext($this->self, (string)$v); } function get_selStart(){ return edit_selstart($this->self, null); } function set_selStart($v){ edit_selstart($this->self, (int)$v); } function get_selLength(){ return edit_sellength($this->self, null); } function set_selLength($v){ edit_sellength($this->self, (int)$v); } function selectAll(){ edit_selectall($this->self); } public function undo(){ edit_undo($this->self); } public function copyToClipboard(){ edit_copytoclipboard($this->self); } public function cutToClipboard(){ edit_cuttoclipboard($this->self); } public function pasteFromClipboard(){ edit_pastefromclipboard($this->self); } public function clearSelected(){ edit_clearselection($this->self); } public function clearSelection(){ $this->clearSelected(); } } class TMemo extends TControl { public $class_name = __CLASS__; protected $_items; function get_items(){ if (!isset($this->_items)){ $this->_items = new TStrings(false); $this->_items->self = __rtii_link($this->self,'Lines'); } return $this->_items; } function get_lines(){ return $this->items; } function set_lines(object $strings){ $this->items->assign($strings); } function set_text($v){ $this->items->text = $v; } function get_text(){ return $this->items->text; } function loadFromFile($fileName){ $fileName = getFileName($fileName); $this->items->loadFromFile($fileName); } function saveToFile($fileName){ $fileName = getFileName($fileName); $this->items->saveToFile($fileName); } function get_selText(){ return edit_seltext($this->self, null); } function set_selText($v){ edit_seltext($this->self, (string)$v); } function get_selStart(){ return edit_selstart($this->self, null); } function set_selStart($v){ edit_selstart($this->self, (int)$v); } function get_selLength(){ return edit_sellength($this->self, null); } function set_selLength($v){ edit_sellength($this->self, (int)$v); } function selectAll(){ edit_selectall($this->self); } public function undo(){ edit_undo($this->self); } public function redo(){ edit_redo($this->self); } public function copyToClipboard(){ edit_copytoclipboard($this->self); } public function cutToClipboard(){ edit_cuttoclipboard($this->self); } public function pasteFromClipboard(){ edit_pastefromclipboard($this->self); } public function clearSelected(){ edit_clearselection($this->self); } public function clearSelection(){ $this->clearSelected(); } } class TRichEdit extends TMemo { public $class_name = __CLASS__; public function loadFromFile($file){ $file = getFileName($file); rich_loadfile($this->self, $file); } public function saveToFile($file){ $file = replaceSr($file); rich_savetofile($this->self, $file); } public function get_RTFText(){ return rich_text($this->self, null); } public function set_RTFText($v){ rich_text($this->self, $v); } public function param($name, $value = null){ return rich_command($this->self, (string)$name, $value); } public function set_fontName($v){ $this->param('name',$v); } public function get_fontName(){ return $this->param('name'); } public function set_fontSize($v){ $this->param('size',$v); } public function get_fontSize(){ return $this->param('size'); } public function set_fontColor($v){ $this->param('color',$v); } public function get_fontColor(){ return $this->param('color'); } public function set_fontCharset($v){ $this->param('charset',$v); } public function get_fontCharset(){ return $this->param('charset'); } public function set_bold($v){ $this->param('bold',(bool)$v); } public function get_bold(){ return $this->param('bold'); } public function set_italic($v){ $this->param('italic',(bool)$v); } public function get_italic(){ return $this->param('italic'); } public function set_strikeout($v){ $this->param('strikeout',(bool)$v); } public function get_strikeout(){ return $this->param('strikeout'); } public function set_underline($v){ $this->param('underline',(bool)$v); } public function get_underline(){ return $this->param('underline'); } } class TCheckBox extends TControl { public $class_name = __CLASS__; public function set_checked($v){ $this->set_prop('checked', (bool)$v); } } class TRadioButton extends TControl { public $class_name = __CLASS__; } class TListBox extends TControl { public $class_name = __CLASS__; protected $_items; function get_items(){ if (!isset($this->_items)){ $this->_items = new TStrings(false); $this->_items->self = __rtii_link($this->self,'Items'); $this->_items->parent_object = $this->self; } return $this->_items; } function get_itemIndex(){ return $this->items->itemIndex; } function set_itemIndex($v){ $this->items->itemIndex = $v; } function set_inText($v){ $this->items->setLine($this->itemIndex, $v); } function get_inText(){ return $this->items->getLine($this->itemIndex); } function set_text($v){ $this->items->text = $v; } function clear(){ $this->text = ''; } function get_text(){ return $this->items->text; } function isSelected($index, $value = null){ if ($index < 0) return false; else return listbox_selected($this->self,$index, $value); } function getSelected(){ $c = $this->items->count; $result = array(); for ($i=0;$i<$c;$i++){ if ($this->isSelected($i)) $result[] = $this->items->getLine($i); } return $result; } function unSelectedAll(){ $c = $this->items->count; $result = array(); for ($i=0;$i<$c;$i++){ $this->isSelected($i, false); } } function setSelected($arr){ $this->unSelectedAll(); foreach ($arr as $el){ $index = $this->items->indexOf($el); $this->isSelected($index, true); } } } class TComboBox extends TControl { public $class_name = __CLASS__; protected $_items; function get_items(){ if (!isset($this->_items)){ $this->_items = new TStrings(false); $this->_items->self = __rtii_link($this->self,'Items'); $this->_items->parent_object = $this->self; } return $this->_items; } function get_itemIndex(){ return $this->items->itemIndex; } function set_itemIndex($v){ $this->items->itemIndex = $v; } function set_text($v){ $this->items->text = $v; } function get_text(){ return $this->items->text; } function set_inText($v){ $this->set_prop('text', $v); } function get_inText(){ return $this->get_prop('text'); } } $_c->setConstList(array('pbHorizontal', 'pbVertical'),0); class TProgressBar extends TControl { public $class_name = __CLASS__; } class TScrollBar extends TControl { public $class_name = __CLASS__; } class TGroupBox extends TControl { public $class_name = __CLASS__; function __construct($onwer=nil,$init=true,$self=nil){ parent::__construct($onwer,$init,$self); $this->parentColor = false; } } class TRadioGroup extends TControl { public $class_name = __CLASS__; protected $_items; function __construct($onwer=nil,$init=true,$self=nil){ parent::__construct($onwer,$init,$self); if ($init) $this->parentColor = false; } function get_items(){ if (!isset($this->_items)){ $this->_items = new TStrings(false); $this->_items->self = __rtii_link($this->self,'Items'); $this->_items->parent_object = $this->self; } return $this->_items; } function set_text($v){ $this->items->text = $v; } function get_text(){ return $this->items->text; } } class TPanel extends TControl { public $class_name = __CLASS__; protected $_constraints; public function __construct($onwer=nil, $init=true, $self=nil){ parent::__construct($onwer,$init,$self); if ($init) $this->parentColor = false; } function get_constraints(){ if (!isset($this->_constraints)){ $this->_constraints = new TSizeConstraints(false); $this->_constraints->self = __rtii_link($this->self,'constraints'); } return $this->_constraints; } } ?><? global $_c; $_c->setConstList(array('blGlyphLeft', 'blGlyphRight', 'blGlyphTop', 'blGlyphBottom'),0); class TButton extends TControl { public $class_name = __CLASS__; } class TBitBtn extends TControl { public $class_name = __CLASS__; protected $_picture; public function get_picture(){ if (!isset($this->_picture)){ $this->_picture = new TBitmap(false); $this->_picture->self = __rtii_link($this->self,'Glyph'); $this->_picture->parent_object = $this->self; } return $this->_picture; } public function doClick(){ eval(get_event($this->self, 'onClick').'('.$this->self.');'); } public function loadPicture($file){ $this->picture->loadAnyFile($file); } public function loadFromBitmap($bt){ $this->picture->assign($bt); } } class TSpeedButton extends TBitBtn { public $class_name = __CLASS__; } ?><? global $_c; $_c->setConstList(array('alNone', 'alTop', 'alBottom', 'alLeft', 'alRight', 'alClient', 'alCustom'),0); $_c->setConstList(array('tsTabs', 'tsButtons', 'tsFlatButtons'),0); $_c->setConstList(array('lbStandard', 'lbOwnerDrawFixed', 'lbOwnerDrawVariable', 'lbVirtual', 'lbVirtualOwnerDraw'),0); $_c->setConstList(array('cbUnchecked', 'cbChecked', 'cbGrayed'),0); $_c->setConstList(array('trHorizontal', 'trVertical'), 0); $_c->setConstList(array('tmBottomRight', 'tmTopLeft', 'tmBoth'), 0); $_c->setConstList(array('tsNone', 'tsAuto', 'tsManual'), 0); $_c->setConstList(array('sbHorizontal', 'sbVertical'), 0); $_c->setConstList(array('scLineUp', 'scLineDown', 'scPageUp', 'scPageDown', 'scPosition', 'scTrack', 'scTop', 'scBottom', 'scEndScroll'),0); $_c->setConstList(array('dfShort','dfLong'), 0); $_c->setConstList(array('dmComboBox','dmUpDown'), 0); $_c->setConstList(array('dtkDate','dtkTime'), 0); $_c->setConstList(array('bsBox', 'bsFrame', 'bsTopLine', 'bsBottomLine', 'bsLeftLine', 'bsRightLine', 'bsSpacer'),0); class TCoolTrayIcon extends TControl { public $class_name = __CLASS__; protected $_picture; protected $_icon; public function get_picture(){ if (!isset($this->_picture)){ $this->_picture = new TIcon(false); $this->_picture->self = __rtii_link($this->self,'Icon'); $this->_picture->parent_object = $this->self; } return $this->_picture; } public function get_icon(){ return $this->picture; } public function loadPicture($file){ $this->picture->loadAnyFile($file); } public function loadFromBitmap($bt){ $this->picture->assign($bt); } public function set_iconFile($v){ $this->aiconFile = $v; $v = getFileName($v); if (!file_exists($v)) return; $this->loadPicture($v); } public function get_iconFile(){ return $this->aiconFile; } public function get_hint(){ return $this->get_prop('hint'); } public function set_hint($v){ $this->set_prop('hint',$v); } public function assign($icon){ trayicon_assign($this->self, $icon->self); } public function showBalloonTip(){ return trayicon_balloontip($this->self, $this->title, $this->text, $this->flag, $this->timeout); } public function hideBalloonTip(){ return trayicon_hideballoontip($this->self); } } class TTrackBar extends TControl { public $class_name = __CLASS__; } class THotKey extends TControl { public $class_name = __CLASS__; public function set_hotKey($sc){ if (!is_numeric($sc)) $sc = text_to_shortcut(strtoupper($sc)); $this->set_prop('hotKey',$sc); } public function get_hotKey(){ $result = $this->get_prop('hotKey'); return shortCut_to_text($result); } } class TMaskEdit extends TControl { public $class_name = __CLASS__; } class TImage extends TControl { public $class_name = __CLASS__; protected $_picture; public function get_picture(){ if (!isset($this->_picture)){ $this->_picture = new TPicture(false); $this->_picture->self = __rtii_link($this->self,'Picture'); $this->_picture->parent_object = $this->self; } return $this->_picture; } public function getCanvas(){ $tmp = new TCanvas(false); $tmp->self = component_canvas($this->self); return $tmp; } public function loadPicture($file){ $this->picture->loadAnyFile($file); } public function loadFromFile($file){ $this->loadPicture($file); } public function loadFromBitmap($bt){ $this->picture->assign($bt); } public function loadFromUrl($url, $ext = false){ $this->picture->loadFromUrl($url, $ext = false); } public function saveToFile($file){ $file = replaceSl($file); $this->picture->saveToFile($file); } } class TMImage extends TImage { public $class_name = __CLASS__; } class TDrawGrid extends TControl { public $class_name = __CLASS__; } class TShape extends TControl { public $class_name = __CLASS__; protected $_brush; protected $_pen; public function get_brush(){ if (!$this->_brush){ $this->_brush = new TBrush(false); $this->_brush->self = __rtii_link($this->self,'Brush'); } return $this->_brush; } public function get_pen(){ if (!$this->_pen){ $this->_pen = new TPen(false); $this->_pen->self = __rtii_link($this->self,'Pen'); } return $this->_pen; } function get_brushColor(){ return $this->brush->color; } function set_brushColor($v){ $this->brush->color = $v; } function get_brushStyle(){ return $this->brush->style; } function set_brushStyle($v){ $this->brush->style = $v; } function get_penColor(){ return $this->pen->color; } function set_penColor($v){ $this->pen->color = $v; } function get_penMode(){ return $this->pen->mode; } function set_penMode($v){ $this->pen->mode = $v; } function get_penStyle(){ return $this->pen->style; } function set_penStyle($v){ $this->pen->style = $v; } function get_penWidth(){ return $this->pen->width; } function set_penWidth($v){ $this->pen->width = $v; } } class TBevel extends TControl { public $class_name = __CLASS__; } class TScrollBox extends TControl { public $class_name = __CLASS__; protected $_constraints; function get_constraints(){ if (!isset($this->_constraints)){ $this->_constraints = new TSizeConstraints(false); $this->_constraints->self = __rtii_link($this->self,'constraints'); } return $this->_constraints; } public function isVScrollShowing(){ return scrollbox_vsshowing($this->self); } public function isHScrollShowing(){ return scrollbox_hsshowing($this->self); } public function get_scrollBarSize(){ return scrollbox_sbsize($this->self); } } class TCheckListBox extends TControl { public $class_name = __CLASS__; protected $_items; function get_items(){ if (!isset($this->_items)){ $this->_items = new TStrings(false); $this->_items->self = __rtii_link($this->self,'Items'); $this->_items->parent_object = $this->self; } return $this->_items; } function isChecked($index){ return checklist_checked($this->self, $index); } function setChecked($index, $value = true){ checklist_setchecked($this->self, $index, $value); } function get_checkedItems(){ $result = array(); $list = $this->items->lines; if (count($list)) foreach ($list as $index=>$v){ if ($this->isChecked($index)) $result[$index] = $v; } return $result; } function set_checkedItems($v){ $list = $this->items->lines; if (count($list)) foreach ($list as $index=>$x){ $this->setChecked($index, in_array($x, $v)); } } function unCheckedAll(){ $this->checkedItems = array(); } function checkedAll(){ $list = $this->items->lines; $this->checkedItems = $list; } function get_itemIndex(){ return $this->items->itemIndex; } function set_itemIndex($v){ $this->items->itemIndex = $v; } function set_inText($v){ $this->items->setLine($this->itemIndex, $v); } function get_inText(){ return $this->items->getLine($this->itemIndex); } function set_text($v){ $this->items->text = $v; } function clear(){ $this->text = ''; } function get_text(){ return $this->items->text; } } class TSplitter extends TControl { public $class_name = __CLASS__; } class TStaticText extends TControl { public $class_name = __CLASS__; } class TControlBar extends TControl { public $class_name = __CLASS__; } class TValueListEditor extends TControl { public $class_name = __CLASS__; } class TLabeledEdit extends TControl { public $class_name = __CLASS__; } class TColorBox extends TControl { public $class_name = __CLASS__; } class TStatusBar extends TControl { public $class_name = __CLASS__; function __construct($onwer=nil,$init=true,$self=nil){ parent::__construct($onwer,$init,$self); if ($init){ $this->useSystemFont = false; $this->simplePanel = true; } } } class TColorListBox extends TControl { public $class_name = __CLASS__; } class TTabSet extends TControl { public $class_name = __CLASS__; } class TTabControl extends TControl { public $class_name = __CLASS__; protected $_tabs; function get_tabs(){ if (!isset($this->_tabs)){ $this->_tabs = new TStrings(false); $this->_tabs->self = __rtii_link($this->self,'tabs'); $this->_tabs->parent_object = $this->self; } return $this->_tabs; } function addPage($caption){ $this->tabs->add($caption); } function indexOfTabXY($x, $y){ return tabcontrol_indexofxy($this->self, $x, $y); } function set_text($v){ $this->tabs->text = $v; } function get_text(){ return $this->tabs->text; } } class TPageControl extends TControl { public $class_name = __CLASS__; public $pages; function __loadDesign(){ $this->__initComponentInfo(); } function __initComponentInfo(){ $index = (int)$this->apageIndex; if ($index == 0){ if ($this->pageCount == 1){ $this->addPage('-'); $this->pageIndex = 1; $this->pageIndex = $index; $this->delete(1); } else { $this->pageIndex = 1; $this->pageIndex = $index; } } else { $this->pageIndex = $index; } } function set_ActivePage($page){ pagecontrol_activepage($this->self, $page->self); $this->apageIndex = $this->pageIndex; } function get_ActivePage(){ return _c(pagecontrol_activepage($this->self, null)); } function addPage($caption){ $p = new TTabSheet(_c($this->owner)); $p->parent = $this; $p->parentControl = $this; $p->caption = $caption; $p->doubleBuffer = true; $p->aenabled = true; $p->avisible = true; return $p; } function get_pageCount(){ return pagecontrol_pagecount($this->self); } function pages(){ $c = $this->pageCount; for ($i=0; $i<$c; $i++){ $result[] = _c(pagecontrol_pages($this->self,$i)); } return $result; } function set_pageIndex($v){ $pages = $this->pages(); if ($pages[$v]){ $this->ActivePage = $pages[$v]; $pages[$v]->visible = true; } } function get_pageIndex(){ $a_page = $this->ActivePage; $pages = $this->pages(); for ($i=0; $i<count($pages); $i++){ if ($pages[$i]->self == $a_page->self) return $i; } return -1; } function set_pagesList($arr){ if (!is_array($arr)) $arr = explode(_BR_, $arr); foreach ($arr as $i=>$el){ if ($el) $tmp[] = trim($el); } unset($arr); $arr =& $tmp; $pages = $this->pages(); for ($i=0; $i<count($pages); $i++){ if (count($arr)-1<$i){ $pages[$i]->free(); } else { $pages[$i]->caption = $arr[$i]; } } for ($i=count($pages)-1; $i<count($arr)-1; $i++) $this->addPage($arr[$i+1]); } function get_pagesList(){ $pages = $this->pages(); $result = array(); for($i=0; $i<count($pages); $i++){ $result[] = $pages[$i]->caption; } return implode(_BR_, $result); } function clear(){ $pages = $this->pages(); for ($i=0; $i<count($pages); $i++) $pages[$i]->free(); } function delete($index){ $pages = $this->pages(); if ($pages[$index]) $pages[$index]->free(); } } class TTabSheet extends TControl { public $class_name = __CLASS__; function set_parentControl($obj){ tabsheet_parent($this->self, $obj->self); } function get_parentControl(){ return _c(tabsheet_parent($this->self,0)); } function free(){ foreach ($this->componentList as $el) $el->free(); parent::free(); } } class TSizeConstraints extends TControl { public $class_name = __CLASS__; } class TPadding extends TControl { public $class_name = __CLASS__; } class TListItems extends TControl { public $class_name = __CLASS__; function delete($index){ listitems_command($this->self, __FUNCTION__, $index,0); } function add(){ return _c(listitems_command($this->self, __FUNCTION__,0,0)); } function clear(){ listitems_command($this->self, __FUNCTION__,0,0); } function addItem($item, $index) { return _c(listitems_command($this->self, __FUNCTION__, $item->self, $index)); } function indexOf($item) { return listitems_command($this->self, __FUNCTION__, $item->self, 0); } function insert($index) { return _c(listitems_command($this->self, __FUNCTION__, $index, 0)); } function count(){ return listitems_command($this->self, __FUNCTION__, 0, 0); } function get($index){ return _c(listitems_command($this->self, __FUNCTION__, $index, 0)); } function get_selected(){ $result = array(); $arr = explode(',',listitems_command($this->self, 'selected', 0,0)); foreach ($arr as $el) if ($el!='') $result[] = $el; return $result; } function set_selected($var){ foreach ($var as $k=>$v) listitems_selected($this->self, $k, $v); } function select($index){ listitems_selected($this->self, $index, true); } function unSelect($index){ listitems_selected($this->self, $index, false); } function unSelectAll(){ $c = $this->count(); for($i=0; $i<$c-1; $i++) $this->unSelect($i); } function selectAll(){ $c = $this->count(); for($i=0; $i<$c-1; $i++) $this->select($i); } function indexByCaption($caption){ $c = $this->count(); $caption = strtolower($caption); for ($i=0; $i<$c; $i++){ $item = $this->get($i); if (strtolower($item->caption)==$caption) return $i; } return -1; } function selectByCaption($caption){ if (is_array($caption)){ $this->unSelectAll(); if (count($caption)){ foreach ($caption as $el){ $index = $this->indexByCaption($el); if ($index > -1) $this->select($index); } } } else { $index = $this->indexByCaption($caption); $this->unSelectAll(); if ($index > -1) $this->select($index); } } function get_selectedCaption(){ $arr = $this->selected; $result = array(); foreach ($arr as $id){ $result[] = $this->get($id)->caption; } return $result; } function set_selectedCaption($caption){ $this->selectByCaption($caption); } } class TListItem extends TControl { public $class_name = __CLASS__; function delete(){ listitem_command($this->self, __FUNCTION__); } function update(){ listitem_command($this->self, __FUNCTION__); } function canceledit(){ listitem_command($this->self, __FUNCTION__); } function editcaption(){ return listitem_command($this->self, __FUNCTION__); } function get_index(){ return listitem_prop($this->self, __FUNCTION__, null);} function get_selected() { return listitem_prop($this->self, __FUNCTION__, null);} function get_imageindex() {return listitem_prop($this->self, __FUNCTION__, null);} function get_stateindex() {return listitem_prop($this->self, __FUNCTION__, null);} function get_indent() {return listitem_prop($this->self, __FUNCTION__, null);} function get_caption() {return listitem_prop($this->self, __FUNCTION__, null);} function get_checked() {return listitem_prop($this->self, __FUNCTION__, null);} function set_imageindex($v) {listitem_prop($this->self, __FUNCTION__, $v);} function set_stateindex($v) {listitem_prop($this->self, __FUNCTION__, $v);} function set_indent($v) {listitem_prop($this->self, __FUNCTION__, $v);} function set_caption($v) {listitem_prop($this->self, __FUNCTION__, $v);} function set_checked($v) {listitem_prop($this->self, __FUNCTION__, $v);} function set_subItems($arr){ if (is_array($arr)) $arr = implode(_BR_, $arr); listitem_prop($this->self, __FUNCTION__, $arr); } function get_subItems(){ $str = listitem_prop($this->self, __FUNCTION__, null); return implode(_BR_, $str); } } class TListView extends TControl { public $class_name = __CLASS__; protected $_items; function get_items(){ if (!$this->_items){ $this->_items = new TListItems($this,false); $this->_items->self = __rtii_link($this->self,'items'); } return $this->_items; } function set_images($c){ imagelist_set_images($this->self, $c->self); } function get_selected(){ return $this->items->get_selected(); } } class TDateTimePicker extends TControl { public $class_name = __CLASS__; public function get_date(){ return datetime_str($this->get_prop('date')); } function set_date($v){ $this->set_prop('date', str_datetime($v)); } function get_maxDate(){ return datetime_str($this->get_prop('maxDate'));} function get_minDate(){ return datetime_str($this->get_prop('minDate'));} function get_time(){return wtime_str($this->get_prop('time'));} function set_maxDate($v){ $this->set_prop('maxDate', str_datetime($v)); } function set_minDate($v){ $this->set_prop('minDate', str_datetime($v)); } function set_time($v){ $this->set_prop('time', str_wtime($v)); } } class TTreeView extends TControl { public $class_name = __CLASS__; public function loadFromStr($str){ tree_loadstr($this->self,$str); } public function get_text(){ return tree_gettext($this->self); } public function set_text($v){ $this->loadFromStr($v); } public function get_itemSelected(){ $arr = explode(_BR_,$this->text); return trim($arr[ $this->absIndex ]); } public function set_itemSelected($v){ $this->absIndex = -1; $v = strtolower($v); $arr = explode(_BR_,$this->text); foreach ($arr as $i=>$text){ $text = strtolower(trim($text)); if ($v==$text){ $this->absIndex = $i; } } } public function get_selected(){ $res = tree_selected($this->self); if ($res === null){ return null; } else return _c( $res ); } public function set_selected($v){ tree_select($this->self, $v->self); } public function get_absIndex(){ $sel = $this->selected; if ($sel) return $sel->absIndex; else return -1; } public function set_absIndex($v){ return tree_setAbsIndex($this->self, (int)$v); } public function fullExpand(){ tree_fullExpand($this->self); } public function fullCollapse(){ tree_fullCollapse($this->self); } } class TTreeNode extends TControl { public $class_name = __CLASS__; public function get_absIndex(){ return tree_absIndex($this->self); } } ?><? class styleMenu { static function add($menu){ stylemenu_command($menu->self, 'add', null); } static function addItem($item){ stylemenu_command($item->self, 'additem', null); } static function param($name,$value = false){ if ($value) stylemenu_command(0, $name, $color); else return stylemenu_command(0, $name, null); } static function selectedColor($color = false){ return self::param('selectedcolor',$color); } static function menuColor($color = false){ return self::param('menucolor',$color); } static function gutterColor($color = false) { return self::param('guttercolor', $color); } static function minHeight($v = false){ return self::param('minheight',$v); } static function minWidth($v = false) { return self::param('minwidth', $v); } } function menuDinamicSetText($menu, $text){ $arr = explode($text); foreach ($arr as $el){ $item = explode('|', $el); $caption = $item[0]; $x = new TMenuItem($menu); $x->caption = $caption; if ($item[1]){ $x->loadPicture($item[1]); } if ($item[2]){ $x->onClick = $item[2]; } $menu->addItem($x); } } class TMainMenu extends TControl { public $class_name = __CLASS__; function set_images(TImageList $il){ } function get_images(){ } function get_items(){ return _c( rtii_get($this, 'Items') ); } function addItem(TMenuItem $item, $parent_item = false){ if ($parent_item) $parent_item->addItem($item); else mainmenu_additem($this->self, $item->self); } } function menuItem($caption, $styled = false, $name = '', $onClick = '', $sc = false, $img = false){ $result = new TMenuItem; if ($name) $result->name = $name; if ($onClick) $result->onClick = $onClick; $result->caption = $caption; if ($sc) $result->shortCut = $sc; if ($img){ if (file_exists( replaceSl($img) )) $result->picture->loadFromFile( replaceSr($img) ); else if (file_exists( replaceSl(DOC_ROOT.'/'.$img) )) $result->picture->loadFromFile( replaceSr(DOC_ROOT.'/'.$img) ); } if ($styled) styleMenu::addItem($result); return $result; } class TMenuItem extends TControl { public $class_name = __CLASS__; public $picture; public function __construct($onwer=nil, $init=true, $self=nil){ parent::__construct($onwer,$init,$self); $this->picture = new TBitmap(false); $this->picture->self = __rtii_link($this->self,'Bitmap'); $this->picture->parent_object = $this->self; } public function loadPicture($file){ $this->picture->loadAnyFile($file); } function set_visible($v){ $this->set_prop('visible', (bool)$v); } function get_visible(){ return $this->get_prop('visible'); } function set_enabled($v){ $this->set_prop('enabled', (bool)$v); } function get_enabled(){ return $this->get_prop('enabled'); } public function set_shortCut($sc){ if (!is_numeric($sc)) $sc = text_to_shortcut(strtoupper($sc)); $this->set_prop('shortCut',$sc); } public function get_shortCut(){ $result = $this->get_prop('shortCut'); return shortCut_to_text($result); } public function addItem(TMenuItem $item){ popup_additemex($this->self, $item->self); } public function clear(){ menuitem_clear($this->self); } public function delete($index){ menuitem_delete($this->self, $index); } public function insert($index, TMenuItem $item){ menu_insert($this->self, (int)$index, $item->self); } public function insertAfter(TMenuItem $after, TMenuItem $item){ $index = $this->indexOf($after); if ($index >= 0){ $this->insert($index+1, $item); } } public function insertBefore(TMenuItem $after, TMenuItem $item){ $index = $this->indexOf($after); if ($index >= 0) $this->insert($index, $item); } public function find($caption){ return _c( menu_find($this->self, (string)$caption) ); } public function get_index(){ return menu_index($this->self); } public function indexOf(TMenuItem $item){ return menu_indexOf($this->self, $item->self); } public function get_parent(){ return _c(menu_parent($this->self)); } } class TMenu extends TControl { public $class_name = __CLASS__; function set_images(TImageList $images){ imagelist_set_images($this->self, $images->self); } } class TPopupMenu extends TControl { public $class_name = __CLASS__; function popup($x,$y){ popup_popup($this->self, (int)$x, (int)$y); } function addItem(TMenuItem $item, $parent_item = false){ if ($parent_item) $parent_item->addItem($item); else popup_additem($this->self, $item->self); } function set_images(TImageList $images){ imagelist_set_images($this->self, $images->self); } function get_items(){ $result = array(); for ($i=0;$i<popup_item_count($this->self)-1;$i++){ $result[] = _c(popup_item_id($i)); } return $result; } function isShow(){ return popup_isshow($this->self); } } ?><? global $_c; $_c->itImage = 0; $_c->itMask = 1; $_c->setConstList (array('dsFocus', 'dsSelected', 'dsNormal', 'dsTransparent'), 0); class TImageList extends TControl { public $class_name = __CLASS__; function addFromFile($file, $color = 0){ $tmp = new TBitmap; $tmp->loadAnyFile( $file ); return $this->altAdd($tmp, $color); } function add(TBitmap $image, TBitmap $mask){ return imagelist_add($this->self, $image->self, $mask->self); } function altAdd(TBitmap $image, $color = 0){ imagelist_altadd($this->self, $image->self, $color); } function addMasked(TBitmap $image, $color){ return imagelist_add_masked($this->self, $image->self, $color); } function insert($index, TBitmap $image, TBitmap $mask){ return imagelist_insert($this->self, $index, $image->self, $mask->self); } function insertMasked($index, TBitmap $image, $color = 0){ imagelist_insertmasked($this->self, $index, $image->self, $color); } function move($curIndex, $newIndex){ imagelist_move($curIndex, $newIndex); } function delete($index){ imagelist_delete($this->self, $index); } function getBitmap($index, TBitmap $image){ return imagelist_get_bitmap($this->self, $index, $image->self); } function get_images($index){ $bmp = new TBitmap; $this->getBitmap($index, $bmp); return $bmp; } function get_count(){ return imagelist_count($this->self); } function get_xwidth(){ return $this->get_prop('width'); } function set_xwidth($v){ $this->set_prop('width',$v); } function get_xheight(){ return $this->get_prop('height'); } function set_xheight($v){ $this->set_prop('height',$v); } }?><? global $_c; $_c->OLECMDID_OPEN = 0x000001; $_c->OLECMDID_NEW = 0x000002; $_c->OLECMDID_SAVE = 0x000003; $_c->OLECMDID_SAVEAS = 0x000004; $_c->OLECMDID_SAVECOPYAS = 0x000005; $_c->OLECMDID_PRINT = 0x000006; $_c->OLECMDID_PRINTPREVIEW = 0x000007; $_c->OLECMDID_PAGESETUP = 0x000008; $_c->OLECMDID_SPELL = 0x000009; $_c->OLECMDID_PROPERTIES = 0x00000A; $_c->OLECMDID_CUT = 0x00000B; $_c->OLECMDID_COPY = 0x00000C; $_c->OLECMDID_PASTE = 0x00000D; $_c->OLECMDID_PASTESPECIAL = 0x00000E; $_c->OLECMDID_UNDO = 0x00000F; $_c->OLECMDID_REDO = 0x000010; $_c->OLECMDID_SELECTALL = 0x000011; $_c->OLECMDID_CLEARSELECTION = 0x000012; $_c->OLECMDID_ZOOM = 0x000013; $_c->OLECMDID_GETZOOMRANGE = 0x000014; $_c->OLECMDID_UPDATECOMMANDS = 0x000015; $_c->OLECMDID_REFRESH = 0x000016; $_c->OLECMDID_STOP = 0x000017; $_c->OLECMDID_HIDETOOLBARS = 0x000018; $_c->OLECMDID_SETPROGRESSMAX = 0x000019; $_c->OLECMDID_SETPROGRESSPOS = 0x00001A; $_c->OLECMDID_SETPROGRESSTEXT = 0x00001B; $_c->OLECMDID_SETTITLE = 0x00001C; $_c->OLECMDID_SETDOWNLOADSTATE = 0x00001D; $_c->OLECMDID_STOPDOWNLOAD = 0x00001E; $_c->OLECMDID_ONTOOLBARACTIVATED = 0x00001F; $_c->OLECMDID_FIND = 0x000020; $_c->OLECMDID_DELETE = 0x000021; $_c->OLECMDID_HTTPEQUIV = 0x000022; $_c->OLECMDID_HTTPEQUIV_DONE = 0x000023; $_c->OLECMDID_ENABLE_INTERACTION = 0x000024; $_c->OLECMDID_ONUNLOAD = 0x000025; $_c->OLECMDID_PROPERTYBAG2 = 0x000026; $_c->OLECMDID_PREREFRESH = 0x000027; $_c->OLECMDID_SHOWSCRIPTERROR = 0x000028; $_c->OLECMDID_SHOWMESSAGE = 0x000029; $_c->OLECMDID_SHOWFIND = 0x00002A; $_c->OLECMDID_SHOWPAGESETUP = 0x00002B; $_c->OLECMDID_SHOWPRINT = 0x00002C; $_c->OLECMDID_CLOSE = 0x00002D; $_c->OLECMDID_ALLOWUILESSSAVEAS = 0x00002E; $_c->OLECMDID_DONTDOWNLOADCSS = 0x00002F; $_c->OLECMDEXECOPT_DODEFAULT = 0x000000; $_c->OLECMDEXECOPT_PROMPTUSER = 0x000001; $_c->OLECMDEXECOPT_DONTPROMPTUSER = 0x000002; $_c->OLECMDEXECOPT_SHOWHELP = 0x000003; class TWebBrowser extends TControl { public $class_name = __CLASS__; public function __construct($onwer=null, $init=true, $self=nil){ if ($init){ if (is_object($onwer)) $this->self = web_create($onwer->self); else $this->self = web_create(null); } if ($self!=nil) $this->self = $self; } public function execWB($cmdID, $cmdExe = OLECMDEXECOPT_PROMPTUSER){ web_execwb($this->self, $cmdID, $cmdExe); } public function toPrint(){ $this->execWB(OLECMDID_PRINT); } public function toSaveAs(){ $this->execWB(OLECMDID_SAVEAS); } public function stop(){ $this->execWB(OLECMDID_STOP); } public function stopDownload(){ $this->execWB(OLECMDID_STOPDOWNLOAD); } public function refresh(){ $this->execWB(OLECMDID_REFRESH); } public function printDialog(){ $this->execWB(OLECMDID_PRINTPREVIEW); } public function open(){ $this->execWB(OLECMDID_OPEN); } public function showPrint(){ $this->execWB(OLECMDID_SHOWPRINT); } public function post($url, $postData){ if (is_array($postData)){ $i = 0; foreach ($postData as $name=>$value){ $i++; if ($i!=1) $result .= '&'; $result .= $name . '=' . $value; } } else { $result = $postData; } web_post($this->self, $url, $result); } public function set_html($html){ web_sethtml($this->self, $html); } public function saveToFile($filename){ $filename = replaceSr($filename); web_savefile($this->self, $filename); } public function navigate($url, $no_sound = true){ web_navigate($this->self, $url, $no_sound); } public function get_url(){ return web_location($this->self); } public function set_url($url){ $this->navigate($url, true); } public function set_width($v){ web_width($this->self, $v); } public function set_height($v){ web_height($this->self, $v); } public function set_h($v){ $this->height = $v; } public function set_w($v){ $this->width = $v; } public function get_busy(){ return web_busy($this->self); } public function goBack(){ return web_back($this->self); } public function goForward(){ return web_forward($this->self); } public function get_protocol(){ return web_protocol($this->self); } function setProxy($ip_port){ web_proxy(trim(str_replace(' ','',$ip_port))); } public function free(){ web_free($this->self); } }?><? class TStringGrid extends TControl { public $class_name = __CLASS__; function setOption($name, $value = true, $ex = false){ $options = array(); if ($ex) $tmp = explode(',',$this->optionsEx); else { $tmp = explode(',',$this->options); } foreach ($tmp as $el) if ($el) $options[] = trim($el); $k = array_search($name, (array)$options); if (!$value){ if ($k!==false) unset($options[$k]); } else { if ($k===false) $options[] = $name; } if ($ex){ $this->optionsEx = implode(',', (array)$options); } else $this->options = implode(',', (array)$options); } function getOption($name, $ex = false){ if ($ex) if (stripos($this->optionsEx, $name)!==false) return true; if (!$ex) if (stripos($this->options, $name)!==false) return true; return false; } function save($head = true){ $this->saveFile($this->filename, $head); } function load($head = true){ $this->loadFile($this->filename, $head); } function clear(){ $this->colCount = 1; $this->rowCount = 1; $this->cells(0,0, ''); } function setString($str, $head = true){ $tmp = explode(_BR_, $str); $arr = array(); if (!$head){ foreach ($tmp as $line){ $arr[] = explode(chr(9), $line); } } else { $colNames = explode(chr(9), $tmp[0]); for ($i=1;$i<count($tmp);$i++){ $line = explode(chr(9), $tmp[$i]); $result = array(); foreach ($colNames as $id=>$name) $result[$name] = $line[$id]; $arr[] = $result; } } $this->setArray($arr, $head); } function getString($head = true){ $arr = $this->getArray($head); if ($head){ $tmp[] = implode(chr(9), array_keys($arr[0])); } foreach ($arr as $line){ $tmp[] = implode(chr(9), $line); } return implode(_BR_, $tmp); } function loadFile($filename, $head = true){ $filename = getFileName($filename); $str = file_get_contents($filename); $this->setString($str, $head); } function saveFile($filename, $head = true){ $filename = replaceSl($filename); $str = $this->getString($head); file_put_contents($filename, $str); } function setArray(array $arr, $head = true){ $this->clear(); $rowCount = count($arr)+1; if ($rowCount == 1) return; if (!$head){ $this->rowCount = count($arr); $this->colCount = count(current($arr)); foreach ($arr as $i=>$line){ $this->rows($i, $line); } return; } $colNames = array_keys($arr[0]); $colCount = count($colNames); $this->colCount = $colCount; $this->rowCount = $rowCount; $this->fixedRows = (int)$head; $this->rows(0, $colNames); $x = 1; foreach ($arr as $colName => $rows){ $this->rows($x, $rows); $x++; } } function getArray($head = true){ $rowCount = $this->rowCount; $colCount = $this->colCount; $result = array(); if ($head){ $colNames = $this->rows(0); for ($i=1; $i<$rowCount; $i++){ $rows = $this->rows($i); foreach ($colNames as $x=>$colName){ $rows[$colName] = $rows[$x]; unset($rows[$x]); } $result[] = $rows; } } else { for ($i=0; $i<$rowCount; $i++){ $result[] = $this->rows($i); } } return $result; } function cells($x, $y, $value = null){ if ($value===null) return grid_cells($this->self, $x, $y, null); else grid_cells($this->self, $x, $y, $value); } function get_col(){ return grid_col($this->self, null); } function set_col($v){ grid_col($this->self, (int)$v); } function get_row(){ return grid_row($this->self, null); } function set_row($v){ grid_row($this->self, $v); } function rows($y, $arr = null){ if ($arr !== null){ if (is_array($arr)) $arr = implode(_BR_, $arr); grid_rows($this->self, (int)$y, $arr); } else { $result = explode(_BR_, grid_rows($this->self, (int)$y, null)); unset($result[count($result)-1]); return $result; } } function cols($x, $arr = null){ if ($arr !== null){ if (is_array($arr)) $arr = implode(_BR_, $arr); grid_cols($this->self, (int)$x, $arr); } else { $result = explode(_BR_, grid_cols($this->self, (int)$x, null)); unset($result[count($result)-1]); return $result; } } function mouseCoord($x, $y){ return grid_mouseCoord($this->self, (int)$x, (int)$y); } function mouseToCell($x, $y){ return grid_mouseToCell($this->self, $x, $y); } function get_rowSelect(){ return $this->getOption('goRowSelect'); } function set_rowSelect($v){ $this->setOption('goRowSelect', $v); } function get_focusSelected(){ return $this->getOption('goDrawFocusSelected'); } function set_focusSelected($v){ $this->setOption('goDrawFocusSelected', $v); } function get_editing(){ return $this->getOption('goEditing'); } function set_editing($v){ $this->setOption('goEditing', $v); } function get_hLine(){ return $this->getOption('goHorzLine'); } function set_hLine($v){ $this->setOption('goHorzLine',$v); } function get_vLine(){ return $this->getOption('goVertLine'); } function set_vLine($v){ $this->setOption('goVertLine',$v); } function get_vLineFixed(){ return $this->getOption('goFixedVertLine'); } function set_vLineFixed($v){ $this->setOption('goFixedVertLine',$v); } function get_hLineFixed(){ return $this->getOption('goFixedHorzLine'); } function set_hLineFixed($v){ $this->setOption('goFixedHorzLine',$v); } function get_rowSizing(){ return $this->getOption('goRowSizing'); } function set_rowSizing($v){ $this->setOption('goRowSizing', $v); } function get_colSizing(){ return $this->getOption('goColSizing'); } function set_colSizing($v){ $this->setOption('goColSizing', $v); } function get_colMoving(){ return $this->getOption('goColMoving'); } function set_colMoving($v){ $this->setOption('goColMoving', $v); } function get_rowMoving(){ return $this->getOption('goRowMoving'); } function set_rowMoving($v){ $this->setOption('goRowMoving', $v); } function get_tabs(){ return $this->getOption('goTabs'); } function set_tabs($v){ $this->setOption('goTabs',$v); } }?><? global $_c; $_c->HKEY_CLASSES_ROOT = 0x80000000; $_c->HKEY_CURRENT_USER = 0x80000001; $_c->HKEY_LOCAL_MACHINE = 0x80000002; $_c->HKEY_USERS = 0x80000003; $_c->HKEY_PERFORMANCE_DATA = 0x80000004; $_c->HKEY_CURRENT_CONFIG = 0x80000005; $_c->HKEY_DYN_DATA = 0x80000006; $_c->STRING = 0; $_c->DATE_TIME = 1; $_c->BOOL = 2; $_c->DWORD = 3; $_c->CURRENCY = 4; class TRegistry { public $self; function __construct(){ $this->self = registry_create(); } function __call($name, $args){ $name = strtolower(str_replace('_','',$name)); if (!isset($args[0])) $args[0] = ''; if (!isset($args[1])) $args[1] = ''; if (!isset($args[2])) $args[2] = ''; return registry_command($this->self, $name, $args[0], $args[1], $args[2]); } function __destruct(){ $this->free(); } function free(){ if ($this->self){ obj_free($this->self); $this->self = false; } } function writeKeyEx($root, $path, $value = '', $type = STRING){ $this->rootKey($root); $path = replaceSr($path); $key = substr($path, 0, strrpos($path, '\\')+1); $p = substr($path, strrpos($path, '\\')+1, strlen($path) - strrpos($path, '\\')); $p = $p=='*' ? '' : $p; if (!$this->openKey($key, true)); switch ($type){ case STRING: $this->writeString($p, $value); break; case BOOL : $this->writeBool($p, $value); break; case DWORD : $this->writeFloat($p, $value); break; case DATE_TIME: $this->writeDate($p, $value); break; default: $this->writeString($p, $value); break; } } function readKeyEx($root, $path, $type = STRING){ $this->rootKey($root); $path = replaceSr($path); $key = substr($path, 0, strrpos($path, "\\")+1); $p = substr($path, strrpos($path, "\\")+1, strlen($path) - strrpos($path, '\\')); $p = $p=='*' ? '' : $p; $this->openKey($key, true); switch ($type){ case STRING: return $this->readString($p); break; case BOOL : return $this->readBool($p); break; case DWORD : return $this->readFloat($p); break; case DATE_TIME: return $this->readDate($p); break; default: return $this->readString($p); break; } } } function registerFileType($prefix, $exe){ $exe = replaceSr($exe); $r = new TRegistry; $r->RootKey(HKEY_CLASSES_ROOT); $r->OpenKey('.'.$prefix, true); $r->WriteString('',$prefix . 'file'); $r->CloseKey(); $r->CreateKey($prefix . 'file'); $r->OpenKey($prefix . 'file\DefaultIcon', true); $r->WriteString('',$exe . ',0'); $r->CloseKey(); $r->OpenKey($prefix . 'file\shell\open\command', true); $r->WriteString('',$exe . ' "%1"'); $r->CloseKey(); $r->Free(); }?><? class TTimer extends TControl{ public $class_name = __CLASS__; } class TTimerEx extends TPanel{ public $class_name_ex = __CLASS__; public $_timer; static function doTimer($self){ $self = cntr_owner($self); $props = TComponent::__getPropExArray($self); if ($props['time_out']){ $obj = _c($self); $obj->timer->enabled = false; } if ($props['ontimer']){ if ($props['workbackground']){ $bw = new Thread; $bw->onWork = $props['ontimer'].'('.$self.');'; $bw->priority = $props['priority']; $bw->start(); } else { eval($props['ontimer'] . '('.$self.');'); } } if ($props['func_name']){ if ($props['checkresult']){ eval('$result = '.$props['func_name'] . ';'); if ( $result===true ){ $obj = _c($self); $obj->free(); } } else eval($props['func_name'] . ';'); } if ($props['freeonend']){ $obj->free(); } } public function __construct($onwer=nil, $init=true, $self=nil){ parent::__construct($onwer,$init,$self); if ($init){ $this->timer->enabled = false; } $this->__setAllPropEx(); } function get_timer(){ if (!$this->timer_self){ $this->_timer = new TTimer($this); $this->_timer->name = 'timer'; $this->_timer->onTimer = 'TTimerEx::doTimer'; $this->timer_self = $this->_timer->self; } else { $this->_timer = c($this->timer_self); } return $this->_timer; } public function set_enable($v){ $this->timer->enabled = $v; } public function get_enable(){ return $this->timer->enabled; } public function set_enabled($v){ $this->enable = $v; } public function get_enabled(){ return $this->enable; } public function set_interval($v){ $this->timer->interval = $v; } public function get_interval(){ return $this->timer->interval; } public function get_repeat(){ return !$this->time_out; } public function set_repeat($v){ $this->time_out = !$v; } public function start(){ $this->enabled = true; } public function stop(){ $this->enabled = false; } public function pause(){ $this->enabled = !$this->enabled; } public function go(){$this->start();} } function setTimeout($interval,$func, $background = false){ $timer = new TTimerEx(); $timer->interval = $interval; $timer->func_name = $func; $timer->time_out = true; $timer->background = $background; $timer->freeOnEnd = true; $timer->enable = true; return $timer; } function setThreadTimer($interval, $func){ $add_str = '; setThreadTimer('.$interval.',\''.addslashes($func).'\');'; setTimeout($interval, $func.$add_str, true); } function setTimer($interval,$func, $background = false){ $timer = new TTimerEx(); $timer->interval = $interval; $timer->func_name = $func; $timer->time_out = false; $timer->background = $background; $timer->enable = true; return $timer; } function setTimerEx($interval,$func){ $tim = setTimer($interval, $func); $tim->checkResult = true; return $tim; } function setInterval($interval, $func, $background = false){ return setTimer($interval, $func, $background); } function setBackTimeout($interval, $func){ return setTimeout($interval, $func, true); } function setBackTimer($interval, $func){ return setTimeout($interval, $func, true); } ?><? global $_c; $_c->MOD_ALT = 1; $_c->MOD_CONTROL = 2; $_c->MOD_SHIFT = 4; $_c->MOD_WIN = 8; $GLOBALS['__key_funcs'] = array(); $GLOBALS['__key_funcs2'] = array(); $GLOBALS['__hotkey_funcs'] = array(); class HotKey { static function event($modifer, $key){ global $__hotkey_funcs; foreach ((array)$__hotkey_funcs as $el){ if (!($el['MODIFER']==$modifer && $el['KEY']==$key)) continue; $func = eval($el['FUNC'].'();'); } } static function add($modifer, $key, $func_name){ global $__hotkey_funcs; reg_hot_key(rand(),$modifer, $key); $__hotkey_funcs[] = array( 'FUNC' => $func_name, 'MODIFER' => $modifer, 'KEY' => $key, ); } } function __onKeyPress(){ for($i=0;$i<255;$i++){ if (get_key_state($i)<0){ global $key_funcs; if (count($key_funcs)==0) return; foreach ((array)$key_funcs as $func) $func($i); } } } function addKeyEvent($func_name){ if (function_exists($func_name)){ global $key_funcs; $key_funcs[] = $func_name; } } function regKeyPress($func_name,$key){ global $key_funcs2; $key_funcs2[$key][] = $func_name; } function __doKeyPress($i){ global $key_funcs2; if (count($key_funcs2)==0) return; if (!array_key_exists($i,$key_funcs2)) return; foreach ((array)$key_funcs2[$i] as $func) $func(); } addKeyEvent('__doKeyPress'); ?><? class Localization { static function init() { $lang_dir = defined('USER_LANG_DIR') ? USER_LANG_DIR : 'lang'; $lang_file = DOC_ROOT.'/'.$lang_dir.'/'.$GLOBALS['__LOCALE_LANG'].'/messages.php'; if (isset($GLOBALS['__LANG_MESSAGES'])) unset($GLOBALS['__LANG_MESSAGES']); $GLOBALS['__LANG_MESSAGES'] = array(); if (file_exists($lang_file)){ require_once $lang_file; global $__M; Localization::setMsgArr($__M); unset ($__M); setlocale(LC_ALL, strtolower($GLOBALS['__LOCALE_LANG']).'_'.strtoupper($GLOBALS['__LOCALE_LANG'])); } } static function inc($file){ $file = replaceSl($file); $dir = dirname($file); $lang_dir = defined('USER_LANG_DIR') ? USER_LANG_DIR : 'lang'; $lang_file = $dir.'/'.$lang_dir.'/'.$GLOBALS['__LOCALE_LANG'].'/messages.php'; if (file_exists($lang_file)){ require_once $lang_file; global $__M; Localization::setMsgArr($__M); unset ($__M); } } static function incXml($dir, $lang = false){ if (!$lang) $lang = $GLOBALS['__LOCALE_LANG']; $lang_file = DOC_ROOT . $dir.'/'.$lang.'.xml'; if (!file_exists($lang_file)) return; $xml = simplexml_load_file($lang_file); foreach ($xml as $item){ $__M[(string)$item->n] = iconv('utf-8', 'windows-1251', (string)$item->v ); } Localization::setMsgArr($__M); unset ($__M); unset($xml); } static function setMsgArr($MSG){ if (is_array($MSG)) $GLOBALS['__LANG_MESSAGES'] = array_merge($MSG,(array)$GLOBALS['__LANG_MESSAGES']); } static function getMsg($name){ if (empty($name)) return ''; if ($name[0]=='&'){ $name[0] = ' '; $name = ltrim($name); } $name = (string)$name; $s1 = isset($GLOBALS['__LANG_MESSAGES'][$name]); $s2 = isset($GLOBALS['__LANG_MESSAGES'][$name.'.']); if (!$s1 and !$s2) return $name; else { if ($s1) return $GLOBALS['__LANG_MESSAGES'][$name]; if ($s2) return $GLOBALS['__LANG_MESSAGES'][$name.'.'].'.'; } } static function setLocale($lang = 'ru'){ $GLOBALS['__LOCALE_LANG'] = $lang; Localization::init(); } static function localForm($form){ global $SCREEN; if ($form->tag == 2012) return; if ( defined('LANG_CHARSET') ) $form->font->charset = LANG_CHARSET; $name = $form->name; $c = $form->componentCount(); for($i=0;$i<$c;$i++){ $s_obj = component_by_id($form->self, $i); $caption = control_text($s_obj, null); if ( strpos($caption, _BR_) ){ $tmp = explode(_BR_, $caption); foreach ($tmp as $q=>$x){ if (ereg('^{(.+)}$', $x)){ $x[0] = ' '; $x[strlen($x)-1] = ' '; $tmp[$q] = self::getMsg(trim($x)); } } $caption = implode(_BR_, $tmp); $ind = tstrings_item_index($s_obj, null); control_text($s_obj, $caption); tstrings_item_index($s_obj, $ind); } elseif ($caption && ereg('^{(.+)}$', $caption)){ $caption[0] = ' '; $caption[strlen($caption)-1] = ' '; control_text($s_obj, self::getMsg(trim($caption)));; } $hint = __rtii_get($s_obj, 'hint'); if ($hint && ereg('^{(.+)}$', $hint)){ $hint[0] = ' '; $hint[strlen($hint)-1] = ' '; __rtii_set($s_obj, 'hint', self::getMsg(trim($hint))); } } $s_obj = $form->self; $caption = __rtii_get($s_obj, 'caption'); if ($caption && ereg('^{(.+)}$', $caption)){ $caption[0] = ' '; $caption[strlen($caption)-1] = ' '; __rtii_set($s_obj, 'caption', self::getMsg(trim($caption))); } $hint = __rtii_get($s_obj, 'hint'); if ($hint && ereg('^{(.+)}$', $hint)){ $hint[0] = ' '; $hint[strlen($hint)-1] = ' '; __rtii_set($s_obj, 'hint', self::getMsg(trim($hint))); } unset($objs); } static function localApplication(){ global $SCREEN; $forms = $SCREEN->forms; foreach ($forms as $form){ self::localForm($form); } unset($forms); } static function detectLocale($str){ $charsets = Array( 'koi8-r' => 0, 'windows-1251' => 0, 'cp866' => 0, 'utf-8' => 0, 'mac' => 0 ); for ( $i = 0, $length = strlen($str); $i < $length; $i++ ) { $char = ord($str[$i]); if ( $char < 128 || $char > 256 ) continue; if (($char > 159 && $char < 176) || ($char > 223 && $char < 242)) $charsets['cp866']+=3; if (($char > 127 && $char < 160)) $charsets['cp866']+=1; if (($char > 191 && $char < 223)) $charsets['koi8-r']+=3; if (($char > 222 && $char < 256)) $charsets['koi8-r']+=1; if ($char > 223 && $char < 256) $charsets['windows-1251']+=3; if ($char > 191 && $char < 224) $charsets['windows-1251']+=1; if ($char > 221 && $char < 255) $charsets['mac']+=3; if ($char > 127 && $char < 160) $charsets['mac']+=1; if ($char > 207 && $char < 240) $charsets['utf-8']+=3; if ($char > 175 && $char < 208) $charsets['utf-8']+=1; } arsort($charsets); return key($charsets); } static function toEncoding($str){ $encoding = self::detectLocale($str); return $encoding = 'windows-1251' ? $str : iconv($encoding, 'windows-1251', $str); } } if (!defined('IS_THREAD')){ v('__LANG_MESSAGES', $GLOBALS['__LANG_MESSAGES']); Thread::addCode('$GLOBALS["__LANG_MESSAGES"] = v("__LANG_MESSAGES");'); } function t($text) { if (func_num_args() == 1) { return Localization::getMsg($text); } $arg = array(); for($i = 1 ; $i < func_num_args(); $i++) { $arg[] = func_get_arg($i); } return vsprintf(Localization::getMsg($text), $arg); } function tr($text){ $params[] = $text; $params = array_merge($params, func_get_args()); return call_user_func_array('t',$params); }?><? global $_c; $_c->ANSI_CHARSET = 0; $_c->DEFAULT_CHARSET = 1; $_c->SYMBOL_CHARSET = 2; $_c->SHIFTJIS_CHARSET = 0x80; $_c->HANGEUL_CHARSET = 129; $_c->GB2312_CHARSET = 134; $_c->CHINESEBIG5_CHARSET = 136; $_c->OEM_CHARSET = 255; $_c->JOHAB_CHARSET = 130; $_c->HEBREW_CHARSET = 177; $_c->ARABIC_CHARSET = 178; $_c->GREEK_CHARSET = 161; $_c->TURKISH_CHARSET = 162; $_c->VIETNAMESE_CHARSET = 163; $_c->THAI_CHARSET = 222; $_c->EASTEUROPE_CHARSET = 238; $_c->RUSSIAN_CHARSET = 204; $_c->MAC_CHARSET = 77; $_c->BALTIC_CHARSET = 186; $_c->EWX_LOGOFF = 0; $_c->EWX_SHUTDOWN = 1; $_c->EWX_REBOOT = 2; $_c->EWX_FORCE = 4; $_c->EWX_POWEROFF = 8; $_c->EWX_FORCEIFHUNG = 0x10; $_c->CSIDL_DESKTOP = 0x0000; $_c->CSIDL_INTERNET = 0x0001; $_c->CSIDL_PROGRAMS = 0x0002; $_c->CSIDL_CONTROLS = 0x0003; $_c->CSIDL_PRINTERS = 0x0004; $_c->CSIDL_PERSONAL = 0x0005; $_c->CSIDL_FAVORITES = 0x0006; $_c->CSIDL_STARTUP = 0x0007; $_c->CSIDL_RECENT = 0x0008; $_c->CSIDL_SENDTO = 0x0009; $_c->CSIDL_BITBUCKET = 0x000a; $_c->CSIDL_STARTMENU = 0x000b; $_c->CSIDL_DESKTOPDIRECTORY = 0x0010; $_c->CSIDL_DRIVES = 0x0011; $_c->CSIDL_NETWORK = 0x0012; $_c->CSIDL_NETHOOD = 0x0013; $_c->CSIDL_FONTS = 0x0014; $_c->CSIDL_TEMPLATES = 0x0015; $_c->CSIDL_COMMON_STARTMENU = 0x0016; $_c->CSIDL_COMMON_PROGRAMS = 0x0017; $_c->CSIDL_COMMON_STARTUP = 0x0018; $_c->CSIDL_COMMON_DESKTOPDIRECTORY = 0x0019; $_c->CSIDL_APPDATA = 0x001a; $_c->CSIDL_PRINTHOOD = 0x001b; $_c->CSIDL_ALTSTARTUP = 0x001d; $_c->CSIDL_COMMON_ALTSTARTUP = 0x001e; $_c->CSIDL_COMMON_FAVORITES = 0x001f; $_c->CSIDL_INTERNET_CACHE = 0x0020; $_c->CSIDL_COOKIES = 0x0021; $_c->CSIDL_HISTORY = 0x0022; $_c->CSIDL_WINDOWS = 0x0024; $_c->CSIDL_ADMINTOOLS = 0x30; $_c->CSIDL_CDBURN_AREA = 0x3b; $_c->CSIDL_COMMON_ADMINTOOLS = 0x2f; $_c->CSIDL_COMMON_APPDATA = 0x23; $_c->CSIDL_COMMON_DOCUMENTS = 0x2e; $_c->CSIDL_COMMON_TEMPLATES = 0x2d; $_c->CSIDL_COMPUTERSNEARME = 0x3d; $_c->CSIDL_CONNECTIONS = 0x31; $_c->CSIDL_MYDOCUMENTS = 0x0c; $_c->CSIDL_PROGRAM_FILES = 0x26; $_c->CSIDL_PROGRAM_FILESX86 = 0x2a; $_c->SM_CXSCREEN = 0; $_c->SM_CYSCREEN = 1; $_c->SM_CXVSCROLL = 2; $_c->SM_CYHSCROLL = 3; $_c->SM_CYCAPTION = 4; $_c->SM_CXBORDER = 5; $_c->SM_CYBORDER = 6; $_c->SM_CXDLGFRAME = 7; $_c->SM_CYDLGFRAME = 8; $_c->SM_CYVTHUMB = 9; $_c->SM_CXHTHUMB = 10; $_c->SM_CXICON = 11; $_c->SM_CYICON = 12; $_c->SM_CXCURSOR = 13; $_c->SM_CYCURSOR = 14; $_c->SM_CYMENU = 15; $_c->SM_CXFULLSCREEN = 0x10; $_c->SM_CYFULLSCREEN = 17; $_c->SM_CYKANJIWINDOW = 18; $_c->SM_MOUSEPRESENT = 19; $_c->SM_CYVSCROLL = 20; $_c->SM_CXHSCROLL = 21; $_c->SM_DEBUG = 22; $_c->SM_SWAPBUTTON = 23; $_c->SM_RESERVED1 = 24; $_c->SM_RESERVED2 = 25; $_c->SM_RESERVED3 = 26; $_c->SM_RESERVED4 = 27; $_c->SM_CXMIN = 28; $_c->SM_CYMIN = 29; $_c->SM_CXSIZE = 30; $_c->SM_CYSIZE = 31; $_c->SM_CXFRAME = 0x20; $_c->SM_CYFRAME = 33; $_c->SM_CXMINTRACK = 34; $_c->SM_CYMINTRACK = 35; $_c->SM_CXDOUBLECLK = 36; $_c->SM_CYDOUBLECLK = 37; $_c->SM_CXICONSPACING = 38; $_c->SM_CYICONSPACING = 39; $_c->SM_MENUDROPALIGNMENT = 40; $_c->SM_PENWINDOWS = 41; $_c->SM_DBCSENABLED = 42; $_c->SM_CMOUSEBUTTONS = 43; $_c->SM_SECURE = 44; $_c->SM_CXEDGE = 45; $_c->SM_CYEDGE = 46; $_c->SM_CXMINSPACING = 47; $_c->SM_CYMINSPACING = 48; $_c->SM_CXSMICON = 49; $_c->SM_CYSMICON = 50; $_c->SM_CYSMCAPTION = 51; $_c->SM_CXSMSIZE = 52; $_c->SM_CYSMSIZE = 53; $_c->SM_CXMENUSIZE = 54; $_c->SM_CYMENUSIZE = 55; $_c->SM_ARRANGE = 56; $_c->SM_CXMINIMIZED = 57; $_c->SM_CYMINIMIZED = 58; $_c->SM_CXMAXTRACK = 59; $_c->SM_CYMAXTRACK = 60; $_c->SM_CXMAXIMIZED = 61; $_c->SM_CYMAXIMIZED = 62; $_c->SM_NETWORK = 63; $_c->SM_CLEANBOOT = 67; $_c->SM_CXDRAG = 68; $_c->SM_CYDRAG = 69; $_c->SM_SHOWSOUNDS = 70; $_c->SM_CXMENUCHECK = 71; $_c->SM_CYMENUCHECK = 72; $_c->SM_SLOWMACHINE = 73; $_c->SM_MIDEASTENABLED = 74; $_c->SM_MOUSEWHEELPRESENT = 75; $_c->SM_CMETRICS = 76; $_c->SM_XVIRTUALSCREEN = 76; $_c->SM_YVIRTUALSCREEN = 77; $_c->SM_CXVIRTUALSCREEN = 78; $_c->SM_CYVIRTUALSCREEN = 79; $_c->SM_CMONITORS = 80; $_c->SM_SAMEDISPLAYFORMAT = 81; $_c->SM_IMMENABLED = 82; $_c->SM_CXFOCUSBORDER = 83; $_c->SM_CYFOCUSBORDER = 84; $_c->MOUSEEVENTF_MOVE = 0x01; $_c->MOUSEEVENTF_LEFTDOWN = 0x02; $_c->MOUSEEVENTF_LEFTUP = 0x04; $_c->MOUSEEVENTF_RIGHTDOWN = 0x08; $_c->MOUSEEVENTF_RIGHTUP = 0x10; $_c->MOUSEEVENTF_MIDDLEDOWN = 0x20; $_c->MOUSEEVENTF_MIDDLEUP = 0x40; $_c->MOUSEEVENTF_WHEEL = 0x0800; $_c->MOUSEEVENTF_ABSOLUTE = 0x8000; function winExit($flag){ win_set_privilege('SeShutdownPrivilege',true); win_exit_windows($flag,0); } function winShutdown(){ winExit(EWX_SHUTDOWN,0); } function winRestart(){ winExit(EWX_REBOOT); } function winLogoff(){ winExit(EWX_LOGOFF); } function winSleep(){ win_sleep(); } function winLocalPath($type){ return replaceSl( trim(__winLocalPath($type)) ); } function selectDirectory($caption, $root, &$buff){ $root = replaceSr($root); $res = select_directory($caption, $root); if ($res<>null){ $res = replaceSl($res); $buff = $res; } return $res <> null; } $GLOBALS['Fonts'] = winLocalPath(CSIDL_FONTS); $GLOBALS['Desktop']= winLocalPath(CSIDL_DESKTOP); $GLOBALS['StartUp']= winLocalPath(CSIDL_STARTMENU); define('EXE_NAME',replaceSl(param_str(0)),false); define('TEMP_DIR',replaceSl(win_tempdir()), false); define('DESKTOP_DIR', replaceSl($GLOBALS['Desktop'])); for ($i=0;$i<99;$i++){ $prs = param_str($i); if (!$prs) break; $GLOBALS['_PARAMS'][] = $prs; } $GLOBALS['argv'] =& $GLOBALS['_PARAMS'];?><? function toObject($obj){ if (is_numeric($obj)) $obj = _c($obj); elseif (!is_object($obj)) $obj = c($obj); return $obj; } function control_xywh($self, $nm, $val = null){ switch ($nm){ case 'x': return control_x($self, $val); case 'y': return control_y($self, $val); case 'w': return control_w($self, $val); case 'h': return control_h($self, $val); } } function cursor_real_x($obj, $offset = 0){ $x = cursor_pos_x(); $w = $GLOBALS['SCREEN']->Width - 20; $x = $x + $offset; if (is_object($obj)) $aw = $obj->w; else $aw = control_w($obj, null); if ($x + $aw > $w) $x = $x - $aw - $offset*2; return $x; } function cursor_real_y($obj, $offset = 0){ $y = cursor_pos_y(); $h = $GLOBALS['SCREEN']->Height - 20; $y = $y + $offset; if (is_object($obj)) $ah = $obj->h; else $ah = control_h($obj, null); if ($y + $ah > $h) $y = $y - $ah - $offset*2; return $y; } function findContrastColor($color){ $color = abs($color); $color = dechex($color); if (strlen($color)==3){ $r = hexdec($color[0]); $g = hexdec($color[1]); $b = hexdec($color[2]); } else { $r = hexdec($color[0].$color[1]); $g = hexdec($color[2].$color[3]); $b = hexdec($color[4].$color[5]); } if ($g < 160) $result = clWhite; else $result = clBlack; return $result; } function toHTMLColor($color){ return sprintf('#%02X%02X%02X', $color&0xFF , ($color>>8)&0xFF , ($color>>16)&0xFF ); } function registerGlobalVar(&$value){ $c = count($GLOBALS[__FUNCTION__]); $GLOBALS[__FUNCTION__][$c+1] =& $value; return $c+1; } function &getGlobalVar($index){ return $GLOBALS['registerGlobalVar'][$index]; } function unsetGlobalVar($index){ $GLOBALS['registerGlobalVar'][$index] = null; } class group { public $objects; static function toLink($obj){ if (is_object($obj)) return $obj->self; elseif (is_numeric($obj)) return $obj; else return c($obj)->self; } function parse($expr){ $prs = explode(',',$expr); foreach ($prs as $pr){ $this->regExpr(trim($pr)); } } function formRegExpr($str){ global $SCREEN; $forms = $SCREEN->formList(); $result = array(); foreach ($forms as $el) if (eregi($str, $el->name)) $result[] = $el; return $result; } function regExpr($str){ $lines = explode('->', $str); if ($GLOBALS['__ownerComponent']) $onwer = c($GLOBALS['__ownerComponent']); else $onwer = $SCREEN->activeForm; if (count($lines)>1){ $onwers = $this->formRegExpr($lines[0]); foreach ($onwers as $onwer){ $links = $onwer->componentLinks; foreach ($links as $link){ $name = component_name($link); if (eregi($lines[1],$name)) $this->addObject($link); } } } elseif (count($lines)==1) { $links = $onwer->componentLinks; foreach ($links as $link){ $name = component_name($link); if (eregi($str,$name)){ $this->addObject($link); } } } } public function __construct($objects = false){ if ($objects) $this->setArray($objects); } public function setArray($objects){ if (!is_array($objects)){ $objects = explode(',',$objects); foreach ($objects as $i=>$el) $objects[$i] = trim($el); } $c = count($objects); for ($i=0; $i<$c; $i++){ $this->addObject($objects[$i]); } } public function clear(){ $this->objects = array(); } public function addObject($obj){ $obj = self::toLink($obj); if (!in_array($obj, (array)$this->objects)) $this->objects[] = $obj; } static function set($self, $nm, $value){ if (in_array(strtolower($nm),array('x','y','w','h'))) return control_xywh($self, $nm, $value); _c($self)->$nm = $value; } function __call($name, $args){ if (!method_exists($this, $name)){ foreach ((array)$this->objects as $obj){ call_user_method($name, _c($obj), $args); } } } function __set($nm, $val){ if (property_exists($this, $nm)){ $this->$nm = $val; return; } foreach ((array)$this->objects as $self){ self::set($self, $nm, $val); } } } class TGroup extends group { }?><? global $_c; $_c->setConstList(array('rmStandart', 'rmBorder'),0); class TsSkinManager extends TControl { public $class_name = __CLASS__; private $_skinAll; static $classes; function __construct($onwer=nil,$init=true,$self=nil){ parent::__construct($onwer,$init,$self); if (!self::$classes){ self::$classes['buttons'] = 'TButton'; self::$classes['bitbtns'] = 'TBitBtn'; self::$classes['speedbuttons'] = 'TSpeedButton'; self::$classes['pagecontrol'] = 'TPageControl'; self::$classes['tabcontrol'] = 'TTabControl'; self::$classes['edits'] = array(); self::$classes['checkboxes'] = array(); self::$classes['groupboxes'] = array(); self::$classes['listviews'] = 'TListView'; self::$classes['panels'] = 'TPanel'; self::$classes['grids'] = 'TStringGrid'; self::$classes['treeviews'] = 'TTreeView'; self::$classes['comboboxes'] = 'TComboBox'; self::$classes['statusbar'] = 'TStatusBar'; self::$classes['edits'] = array('TEdit','TMemo','TMaskEdit','THotKey','TListBox', 'TCheckListBox','TRichEdit','TDateTimePicker'); self::$classes['checkboxes'] = array('TCheckBox','TRadioButton'); self::$classes['groupboxes'] = array('TGroupBox'); } $this->SkinningRules = 'srStdDialogs, srThirdParty'; $this->skinAll = true; } public function updateSkin(){ skins_updateSkin($this->self); } public function get_skinFile(){ return replaceSl($this->skinDirectory . '/' . $this->skinName . '.asz'); } public function set_skinFile($v){ $v = getFileName($v); $skinName = basenameNoExt($v); $skinDir = dirname($v); $this->skinDirectory = str_replace('\\\\','\\',replaceSr($skinDir)); $this->skinName = $skinName; } public function get_skinAll(){ return $this->askinAll; } public function set_skinAll($v){ $this->askinAll = $v; $val = $v ? 'def' : ''; $types = array_keys(self::$classes); foreach ($types as $type) $this->setThirdParty($type, $val); } public function setThirdParty($type, $value){ if ($value=='def') $value = self::$classes[$type]; if ( is_array($value) ) $value = implode(_BR_, $value); skins_thirdparty($this->self, $type, $value); } public function getThirdParty($type){ $result = skins_thirdparty($this->self, $type, null); return explode(_BR_, $result); } } class TsSkinProvider extends TControl { public $class_name = __CLASS__; function __construct($onwer=nil,$init=true,$self=nil){ parent::__construct($onwer,$init,$self); if ($init){ $this->useGlobalColor = false; $this->showAppIcon = true; $this->CaptionAlignment = taLeftJustify; $this->resizeMode = rmStandart; } } } class TsLabel extends TLabel { public $class_name = __CLASS__; function __construct($onwer=nil,$init=true,$self=nil){ parent::__construct($onwer,$init,$self); if ($init){ $this->useSkinColor = false; } } } class TsLabelFX extends TLabel { public $class_name = __CLASS__; function __construct($onwer=nil,$init=true,$self=nil){ parent::__construct($onwer,$init,$self); if ($init){ $this->useSkinColor = false; } } } class TsBitBtn extends TControl { public $class_name = __CLASS__; function __construct($onwer=nil,$init=true,$self=nil){ parent::__construct($onwer,$init,$self); if ($init){ } } } class TsSpeedButton extends TSpeedButton { public $class_name = __CLASS__; function __construct($onwer=nil,$init=true,$self=nil){ parent::__construct($onwer,$init,$self); if ($init){ } } } class TsProgressBar extends TProgressBar { public $class_name = __CLASS__; } class TsTrackBar extends TTrackBar { public $class_name = __CLASS__; } class TsBevel extends TBevel { public $class_name = __CLASS__; }?>?><? function shortName($file){ global $progDir; if (file_exists($progDir.'\\'.$file)) return $progDir.'\\'.$file; else return $file; } function fileExt($file){ $file = basename($file); $k = strrpos($file,'.'); if ($k===false) return ''; return strtolower(substr($file, $k+1, strlen($file)-$k-1)); } function checkExt($file, $ext){ $file_ext = fileExt($file); if (is_array($ext)){ foreach ($ext as $item){ $item = str_replace('.', '', strtolower(trim($item))); if ($item == $file_ext) return true; } } else { $ext = str_replace('.', '', strtolower(trim($ext))); if ($ext == $file_ext) return true; } return false; } function basenameNoExt($file){ $file = basename($file); $ext = fileExt($file); return str_ireplace('.' . $ext, '', $file); } function getFileName($str, $check = true){ if ($check && function_exists('resFile')){ return resFile($str); } $last_s = $str; if (!file_exists($str)) $str = DOC_ROOT .'/'. $str; if (!file_exists($str)) $str = $last_s; else $str = str_replace('/', DIRECTORY_SEPARATOR, $str); return $str; } function findFiles($dir, $exts = null, $recursive = false, $with_dir = false){ $dir = replaceSl($dir); $result = array(); $check_ext = $exts; if (!file_exists($dir)) return array(); if ($handle = @opendir($dir)) while (($file = readdir($handle)) !== false){ if ($file == '.' || $file == '..') continue; if (is_file($dir . '/' . $file)){ if ($check_ext){ if (checkExt($file, $exts)) $result[] = $with_dir ? $dir .'/'. $file : $file; } else { $result[] = $with_dir ? $dir .'/'. $file : $file; } } elseif ($recursive && is_dir($dir . '/' . $file)){ $result = array_merge($result, findFiles($dir . '/' . $file, $exts, true, $with_dir)); } } return $result; } function findDirs($dir){ $dir = replaceSl($dir); if (!is_dir($dir)) return array(); $files = scandir($dir); array_shift($files); array_shift($files); $result = array(); foreach ($files as $file){ if (is_dir($dir .'/'. $file)){ $result[] = $file; } } return $result; } function rmdir_recursive($dir) { $dir = replaceSl($dir); if (!is_dir($dir)) return false; $files = scandir($dir); array_shift($files); array_shift($files); foreach ($files as $file) { $file = $dir . '/' . $file; if (is_dir($file)) { rmdir_recursive($file); if (is_dir($file)) rmdir($file); } else { unlink($file); } } rmdir($dir); } function deleteDir($dir, $dir_del = true, $exts = null){ $dir = replaceSl($dir); $files = findFiles($dir, $exts, true, true); foreach ($files as $file){ if (file_exists($file)) unlink($file); } if ($dir_del) rmdir_recursive($dir); } function include_ex($file){ $file = getFileName($file); include_enc($file); } function fileLock($file){ $file = getFileName($file); $fp = fopen($file, "a"); flock($fp, LOCK_SH); $GLOBALS['__fileLock'][$file] = $fp; } function fileUnlock($file){ $file = getFileName($file); if (isset($GLOBALS['__fileLock'][$file])) flock($GLOBALS['__fileLock'][$file], LOCK_UN); } function dirLock($dir, $exts = null){ $files = findFiles($dir, $exts, true, true); foreach ($files as $file) fileLock($file); } function dirUnlock($dir, $exts = null){ $files = findDirs($dir, $exts, true, true); foreach ($files as $file) fileUnlock($file); } function file_p_contents($file, $data){ $file = replaceSl($file); $dir = dirname($file); if (!file_exists($dir)) mkdir($dir, 0777, true); return file_put_contents($file, $data); } function x_copy($from, $to){ $from = replaceSl($from); $to = replaceSl($to); $dir = dirname($to); if (!file_exists($dir)) mkdir($dir, 0777, true); return copy($from, $to); } function x_move($from, $to){ $x = 0; while (!x_copy($from, $to)){ if ($x>30){ break; } $x++; } $x = 0; while (!unlink($from)){ if ($x>30) break; $x++; } }?><? class __ini { var $parse_constants = TRUE, $use_defaults = TRUE, $_ini_loaded = FALSE, $_default_loaded = FALSE, $_error_pattern = '[ini] %s', $_settings = array ( 'ini' => array (), 'default' => array () ) ; function ini ( $ini_file = NULL, $default_file = NULL ) { if ( !is_null ( $ini_file ) ) { $this->read_ini ( $ini_file, FALSE ); if ( !is_null ( $default_file ) ) { $this->read_defaults ( $default_file ); } } } function get ( $key, $section = NULL ) { $ini_value = $this->_get_value ( $key, 'ini', $section ); $def_value = $this->_get_value ( $key, 'default', $section ); if ( is_null ( $ini_value ) && $this->use_defaults ) { return $def_value; } else { return $ini_value; } } function _get_value ( $key, $type, $section = NULL ) { if ( is_null ( $section ) ) { if ( isset ( $this->_settings[ $type ][ $key ] ) ) { return $this->_settings[ $type ][ $key ]; } else { return NULL; } } else { if ( isset ( $this->_settings[ $type ][ $section ][ $key ] ) ) { return $this->_settings[ $type ][ $section ][ $key ]; } else { return NULL; } } } function read_ini ( $filename, $return_ini = FALSE ) { if ( $content = $this->_read_file ( $filename ) ) { $this->_settings[ 'ini' ] = $this->_parse ( $content ); $this->_ini_loaded = TRUE; if ( $return_ini ) { return $this->_settings[ 'ini' ]; } else { return TRUE; } } else { return FALSE; } } function read_defaults ( $filename ) { if ( $content = $this->_read_file ( $filename ) ) { $this->_settings[ 'default' ] = $this->_parse ( $content ); $this->default_loaded = TRUE; return TRUE; } else { return FALSE; } } function _read_file ( $filename ) { if ( !file_exists ( $filename ) ) { trigger_error ( $this->_errstr ( 'File does not exist: "' . $filename . '"' ), E_USER_ERROR ); return FALSE; } $content = @file ( $filename ); if ( !is_array ( $content ) ) { trigger_error ( $this->_errstr ( 'an error occured while reading "' . $filename . '"' ), E_USER_ERROR ); return FALSE; } return join ( '', $content ); } function _parse ( & $str_content ) { $comments = array ( '/#[^\n]*/', '/\/\/[^\n]*/' ); $ini = array (); $arr_content = array (); $current_section = FALSE; $line = ''; $key = ''; $value = ''; $str_content = str_replace ( "\r\n", "\n", $str_content ); $str_content = preg_replace ( $comments, '', $str_content ); $str_content = split ( "\n", $str_content ); foreach ( $str_content as $key => $line ) { $line = trim ( $line ); if ( !empty ( $line ) ) { if ( preg_match ( '/(?:\[)(.*)(?=])/', $line, $matches ) ) { $current_section = $matches[ 1 ]; } elseif ( preg_match ( '/(.+)(?:=)(.+)/', $line, $matches ) ) { $key = trim ( $matches[ 1 ] ); $value = trim ( $matches[ 2 ] ); if ( preg_match ( '/(^".*"$)|(^\'.*\'$)/', $value ) ) { $value = substr ( $value, 1, -1 ); } elseif ( $this->parse_constants ) { if ( defined ( $value ) ) { $value = constant ( $value ); } } if ( $current_section === FALSE ) { $ini[ $key ] = $value; } else { $ini[ $current_section ][ $key ] = $value; } } else { } } } return $ini; } function _errstr ( $message ) { return sprintf ( $this->_error_pattern , $message ); } } class TIniFile { public $values; protected $ini; function __construct($file = '', $with_kavs = false){ $this->ini = new __Ini; if (file_exists($file)) $this->loadFromFile($file, $with_kavs); } function loadFromFile($file, $with_kavs = false, $return = true){ $file = replaceSl($file); if (!file_exists($file)) return; $this->values = $this->ini->read_ini($file, true); if ($with_kavs){ foreach ($this->values as $i=>$val){ foreach ($val as $k=>$v){ $v[0] = ' '; $v[strlen($v)-1] = ' '; $this->values[$i][$k] = trim($v); } } } if ($return) return $this->values; } function loadFile($file){ return $this->loadFromFile($file); } function sections(){ return array_keys($this->values); } function getSection($section){ return (array)$this->values[$section]; } function saveToFile($file){ $file = replaceSl($file); $result = ''; foreach ($this->values as $section => $val){ if (!is_array($val)) continue; $result .= '['.$section.']' . _BR_; foreach ($val as $k=>$v) $result .= $k .'='.$v . _BR_; $result .= _BR_; } return file_put_contents($file, $result); } } class TConfigIni extends TConfig { public $class_name = __CLASS__; public $ini; protected $_result; public function __construct(array $data = array()){ parent::__construct($data); $this->ini = new TIniFile; } function saveToFile($filename){ $this->ini->values = $this->toArray(); $this->ini->saveToFile($filename); } function loadFromFile($filename){ $arr2 = $this->toArray(); $arr = (array)$this->ini->loadFromFile($filename); foreach ($arr as $k=>$v){ if (is_array($v)) foreach ($v as $key=>$value) $arr2[$k][$key] = $value; } $this->setArray($arr2); } } function iniConfiger(TConfig $cfg = null){ $result = new TConfigIni; if ($cfg != null){ $result->setArray($cfg->toArray()); } return $result; }?><? class TIniFileEx { public $filename; public $arr; function __construct($file = false){ if ($file) $this->loadFromFile($file); } function initArray(){ $this->arr = parse_ini_file($this->filename, true); } function loadFromFile($file){ $result = true; $file = replaceSl($file); $this->filename = $file; if (file_exists($file) && is_readable($file)){ $this->initArray(); } else $result = false; return $result; } function read($section, $key, $def = ''){ if (isset($this->arr[$section][$key])){ return $this->arr[$section][$key]; } else return $def; } function write($section, $key, $value){ if (is_bool($value)) $value = $value ? 1 : 0; $this->arr[$section][$key] = $value; } function eraseSection($section){ if (isset($this->arr[$section])) unset($this->arr[$section]); } function deleteKey($section, $key){ if (isset($this->arr[$section][$key])) unset($this->arr[$section][$key]); } function readSections(&$array){ $array = array_keys($this->arr); return $array; } function readKeys($section, &$array){ if (isset($this->arr[$section])){ $array = array_keys($this->arr[$section]); return $array; } return array(); } function updateFile(){ $this->filename = replaceSl($this->filename); $result = ''; foreach ($this->arr as $sname=>$section){ $result .= '[' . $sname . ']' . _BR_; foreach ($section as $key=>$value){ $result .= $key .'='.$value . _BR_; } $result .= _BR_; } file_p_contents($this->filename, $result); return true; } function __destruct(){ } }?><? global $_c; $_c->setConstList('scsReady', 'scsMoving', 'scsSizing', 0); class TSizeCtrl extends TControl{ public $class_name = __CLASS__; public $targets = array(); public function set_enable($b){ sizectrl_enable($this->self, $b); } public function get_enable() { return sizectrl_enable($this->self, null); } public function set_popupMenu($menu){ popup_set($menu->self, $this->self); } public function indexOf($target){ $result = 0; $self = $target->self; $c = count($this->targets); for($i=0;$i<$c;$i++){ if ($this->targets[$i]->self == $self) return $i; } return -1; foreach ($this->targets as $obj){ if ($obj->self == $target->self) return $result; $result++; } return -1; } public function addTarget($target, $init = true){ $this->targets[] = $target; if ($init) return sizectrl_add_target($this->self, $target->self); } public function deleteTarget($target){ sizectrl_delete_target($this->self, $target->self); } public function unRegisterTarget($target){ sizectrl_unregister($this->self, $target->self); } public function registerTarget($target){ sizectrl_register($this->self, $target->self); } public function clearTargets(){ sizectrl_clear_targets($this->self); $this->targets = array(); } public function unRegisterAll(){ sizectrl_unregister_all($this->self); $this->targets = array(); } public function update(){ sizectrl_update($this->self); $this->targets_ex = array(); } public function updateBtns(){ sizectrl_updateBtns($this->self); } public function getSelected(){ return sizectrl_selected($this->self); } public function get_targets_ex(){ $result = array(); $tmp = $this->getSelected(); foreach ($tmp as $link) $result[$link] = _c($link); return $result; } }?>?>?><? global $_c; class TEditBtn extends TPanel { const BUTTON_HEIGTH = 26; public $btn; public $edit; public $class_name_ex = __CLASS__; function set_onSelectClick($str){ $this->btn->onClick = $str; } function set_onKeyPress($str){ $this->edit->onKeyPress = $str; } function set_onKeyUp($str){ $this->edit->onKeyUp = $str; } function set_onKeyDown($str){ $this->edit->onKeyDown = $str; } function set_onChange($str){ $this->edit->onChange = $str; } function __initComponentInfo(){ $this->createComponents(); $this->initComponents(); $this->text = $this->atext; $this->readOnly = $this->areadOnly; $this->caption = $this->acaption; } function __construct($onwer=nil,$init=true,$self=nil){ parent::__construct($onwer,$init,$self); $this->bevelOuter = 'bvNone'; if ($init){ $this->text = ''; $this->createComponents(); } else { $this->edit = _c($this->edit_link); $this->btn = _c($this->btn_link); } $this->initComponents(); $this->__setAllPropEx($init); } function createComponents(){ $this->btn = new TBitBtn($this); $this->btn->parent = $this; $this->edit = new TEdit($this); $this->edit->parent = $this; $this->edit->name = 'edit'; $this->btn->name = 'btn'; $this->edit->text = ''; $this->btn->caption = '...'; $this->edit_link = $this->edit->self; $this->btn_link = $this->btn->self; $this->height = $this->edit->h + 2; } function initComponents(){ $this->caption = ' '; $this->edit->left = 0; $this->edit->top = 0; $this->edit->width = $this->width - self::BUTTON_HEIGTH - 4; $this->edit->anchors = 'akLeft, akRight, akTop'; $this->btn->top = 0; $this->btn->width = self::BUTTON_HEIGTH; $this->btn->height = $this->edit->height; $this->btn->left = $this->width - self::BUTTON_HEIGTH; $this->caption = ' '; $this->btn->anchors = 'akRight, akTop'; } function set_text($v){ $this->edit->text = $v; $this->atext = $v; } function get_text(){ return $this->edit->text; } function set_caption($v){ $this->btn->text = $v; $this->acaption = $v; } function get_caption(){ return $this->btn->text; } function set_readOnly($v){ $this->edit->readOnly = (bool)$v; $this->areadOnly = (bool)$v; } function get_readOnly(){ return $this->edit->readOnly; } function __set($name, $value){ parent::__set($name, $value); if ($name=='name'){ $this->text = $value; } $this->initComponents(); } } class TEditDialog extends TEditBtn { public $dlg; public $dlg_type; public $class_name_ex = __CLASS__; function __initComponentInfo(){ parent::__initComponentInfo(); $class = $this->dlg_type; $this->dlg = new $class($this); $this->dlg->name = 'dlg'; $this->filter = $this->afilter; } function __construct($onwer=nil,$init=true,$self=nil){ parent::__construct($onwer,$init,$self); $class = $this->dlg_type; if ($class) if ($init){ $this->dlg = new $class($this); $this->dlg_link = $this->dlg->self; } else { $this->dlg = _c($this->dlg_link); } $this->onSelectClick = $this->class_name_ex . '::selectDialog'; $this->__setAllPropEx($init); } function selectDialog($self){ $obj = _c(_c($self)->owner); if ($obj->dlg->execute()){ $obj->text = $obj->dlg->fileName; if ($obj->onSelect) eval($obj->onSelect . "(".$obj->self.",'" . $obj->dlg->fileName . "');"); } } function set_onSelect($v){ $this->onSelect = $v; } function set_filter($v){ $this->dlg->filter = $v; $this->afilter = $v; } function get_filter($v){ return $this->dlg->filter; } } class TEditOpenDialog extends TEditDialog { public $class_name_ex = __CLASS__; function __construct($onwer=nil,$init=true,$self=nil){ $this->dlg_type = 'TOpenDialog'; parent::__construct($onwer,$init,$self); } } class TEditSaveDialog extends TEditDialog { public $class_name_ex = __CLASS__; function __construct($onwer=nil,$init=true,$self=nil){ $this->dlg_type = 'TSaveDialog'; parent::__construct($onwer,$init,$self); } } class TEditFontDialog extends TEditDialog { public $class_name_ex = __CLASS__; function __construct($onwer=nil,$init=true,$self=nil){ $this->dlg_type = 'TFontDialog'; parent::__construct($onwer,$init,$self); $this->readOnly = true; $this->text = '('. t('Font options') .')'; } function selectDialog($self){ $obj = _c(_c($self)->owner); if ($obj->dlg->execute()){ $obj->value = $obj->dlg->font; if ($obj->onSelect){ $font = $obj->dlg->font; eval($obj->onSelect . '(' . $obj->self . ',$font);'); } } } function set_value($font){ $last_size = $this->edit->font->size; $this->edit->font->assign($font); $this->dlg->font->assign($font); $this->edit->font->size = $last_size; } function get_value(){ return $this->dlg->font; } } class TEditColorDialog extends TEditDialog { public $class_name_ex = __CLASS__; function __initComponentInfo(){ parent::__initComponentInfo(); $this->color = $this->acolor; } function __construct($onwer=nil,$init=true,$self=nil){ $this->dlg_type = 'TColorDialog'; parent::__construct($onwer,$init,$self); $this->readOnly = true; $this->value = $this->dlg->color; $this->__setAllPropEx(); } function selectDialog($self){ $obj = _c(_c($self)->owner); if ($obj->dlg->execute()){ $obj->value = $obj->dlg->color; if ($obj->onSelect){ $color = $obj->dlg->color; eval($obj->onSelect . '(' . $obj->self . ',$color);'); } } } function set_value($color){ if ($color == clNone){ $this->edit->text = 'None'; $this->edit->color = clWhite; } else{ $this->edit->text = '0x'.dechex($color); $this->edit->color = $color; } $this->dlg->color = $color; $this->acolor = $color; } function get_value(){ return $this->dlg->color; } } class TEditDMSColorDialog extends TEditDialog { public $class_name_ex = __CLASS__; function __construct($onwer=nil,$init=true,$self=nil){ parent::__construct($onwer,$init,$self); if ($init) $this->readOnly = true; $this->__setAllPropEx($init); } function selectDialog($self){ $obj = _c(_c($self)->owner); $dlg = new TDMSColorDialog; $dlg->color = $obj->value; $x = cursor_real_x($dlg->form,10); $y = cursor_real_y($dlg->form,10); if ($dlg->execute($x, $y)){ $obj->value = $dlg->color; if ($obj->onSelect){ $color = $dlg->color; eval($obj->onSelect . '(' . $obj->self . ',$color);'); } } $dlg->free(); } function set_value($color){ $this->edit->fontColor = findContrastColor($color); $this->edit->color = $color; $this->edit->text = '0x'.dechex($color); $this->acolor = $color; } function get_value(){ return $this->acolor; } }?><? class TMCIPlayer extends _Object{ public $file; public $is_play = false; private $_enable = false; function __construct(){ $this->is_play = false; $this->enable = true; } function get_filename(){ return $this->file; } function set_filename($v){ $this->file = getFileName($v); mci_command('filename',$this->file); } function play(){ mci_command('play',0); $this->is_play = true; } function open(){ mci_command('open',0); } function stop(){ mci_command('stop',0); $this->is_play = false; } function pause(){ mci_command('pause',0); $this->is_play = !$this->is_play; } function get_position(){ return mci_command('position',false); } function set_position($v){ mci_command('position',$v); } function get_length(){ return mci_command('length',0); } function get_start(){ return mci_command('start',0); } function get_startpos(){ return mci_command('startpos',0); } function get_endpos(){ return mci_command('endpos',0); } function eject(){ return mci_command('eject',0); } function set_enable($v){ mci_command('enable',$v); $this->_enable = $v; } function get_enable(){ return (bool)$this->_enable; } function set_autoopen($v){ mci_command('autoopen',$v); } function set_autorewind($v){ mci_command('autorewind',$v); } function set_autoenable($v){ mci_command('autoenable',$v); } function set_shareable($v){ mci_command('shareable',$v); } }?><? $GLOBALS['SCREEN'] = new TScreenEx; $GLOBALS['APPLICATION'] = to_object(get_application(),'TApplication'); define('SoulEngine_Loaded',true, false);?>